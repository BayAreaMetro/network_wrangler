<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>network_wrangler.roadwaynetwork &mdash; Network Wrangler  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=eafc0fe6" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=df4b10f6"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../" class="icon icon-home">
            Network Wrangler
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search/" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../design/">Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autodoc/">Wrangler Classes and Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing/">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../todo/">To Do List</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../">Network Wrangler</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../">Module code</a></li>
      <li class="breadcrumb-item active">network_wrangler.roadwaynetwork</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for network_wrangler.roadwaynetwork</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">randint</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">folium</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">osmnx</span> <span class="k">as</span> <span class="nn">ox</span>

<span class="kn">from</span> <span class="nn">geopandas.geodataframe</span> <span class="kn">import</span> <span class="n">GeoDataFrame</span>

<span class="kn">from</span> <span class="nn">pandas.core.frame</span> <span class="kn">import</span> <span class="n">DataFrame</span>

<span class="kn">from</span> <span class="nn">jsonschema</span> <span class="kn">import</span> <span class="n">validate</span>
<span class="kn">from</span> <span class="nn">jsonschema.exceptions</span> <span class="kn">import</span> <span class="n">ValidationError</span>
<span class="kn">from</span> <span class="nn">jsonschema.exceptions</span> <span class="kn">import</span> <span class="n">SchemaError</span>

<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">LineString</span>

<span class="kn">from</span> <span class="nn">.logger</span> <span class="kn">import</span> <span class="n">WranglerLogger</span>
<span class="kn">from</span> <span class="nn">.projectcard</span> <span class="kn">import</span> <span class="n">ProjectCard</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">point_df_to_geojson</span><span class="p">,</span> <span class="n">link_df_to_json</span><span class="p">,</span> <span class="n">parse_time_spans</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">offset_location_reference</span><span class="p">,</span> <span class="n">haversine_distance</span><span class="p">,</span> <span class="n">create_unique_shape_id</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">create_location_reference_from_nodes</span><span class="p">,</span> <span class="n">create_line_string</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">update_df</span>

<span class="c1"># Coordinate reference system</span>
<span class="n">CRS</span> <span class="o">=</span> <span class="mi">4326</span>  <span class="c1"># AKA EPSG:4326, WGS 1984</span>

<span class="c1"># Foreign key variables in data model</span>
<span class="n">NODE_FOREIGN_KEY</span> <span class="o">=</span> <span class="s2">&quot;model_node_id&quot;</span>
<span class="n">LINK_FOREIGN_KEY</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">]</span>
<span class="n">SHAPE_FOREIGN_KEY</span> <span class="o">=</span> <span class="s2">&quot;id&quot;</span>  <span class="c1"># formerly UNIQUE_SHAPE_ID</span>

<span class="c1"># List of variables that are unique such that they can be directly queried and you should get a single item returned</span>
<span class="n">UNIQUE_LINK_IDS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;model_link_id&quot;</span><span class="p">]</span>
<span class="n">UNIQUE_NODE_IDS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;model_node_id&quot;</span><span class="p">]</span>

<span class="c1"># Minimum requirements for selection query</span>
<span class="n">SELECTION_REQUIRES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;link&quot;</span><span class="p">]</span>

<span class="c1"># Scalar values added to primary keys for nodes and links for corresponding managed lanes</span>
<span class="c1"># MTC</span>
<span class="n">MANAGED_LANES_NODE_ID_SCALAR</span> <span class="o">=</span> <span class="mi">4500000</span>
<span class="n">MANAGED_LANES_LINK_ID_SCALAR</span> <span class="o">=</span> <span class="mi">10000000</span>

<span class="c1"># Required attributes to specify for managed lanes</span>
<span class="n">MANAGED_LANES_REQUIRED_ATTRIBUTES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;A&quot;</span><span class="p">,</span>
    <span class="s2">&quot;B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;model_link_id&quot;</span><span class="p">,</span>
    <span class="s2">&quot;locationReferences&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Attributes to copy (keep same) from general purpose lanes to corresponding managed lanes</span>
<span class="n">KEEP_SAME_ATTRIBUTES_ML_AND_GP</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;distance&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bike_access&quot;</span><span class="p">,</span>
    <span class="s2">&quot;drive_access&quot;</span><span class="p">,</span>
    <span class="s2">&quot;transit_access&quot;</span><span class="p">,</span>
    <span class="s2">&quot;walk_access&quot;</span><span class="p">,</span>
    <span class="s2">&quot;maxspeed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="p">,</span>
    <span class="s2">&quot;oneway&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ref&quot;</span><span class="p">,</span>
    <span class="s2">&quot;roadway&quot;</span><span class="p">,</span>
    <span class="s2">&quot;length&quot;</span><span class="p">,</span>
    <span class="s2">&quot;segment_id&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ft&quot;</span><span class="p">,</span>
    <span class="s2">&quot;assignable&quot;</span><span class="p">,</span>
    <span class="s1">&#39;county&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># Mapping of modes to variables in the network</span>
<span class="n">MODES_TO_NETWORK_LINK_VARIABLES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;drive&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;drive_access&quot;</span><span class="p">],</span>
    <span class="s2">&quot;bus&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;bus_only&quot;</span><span class="p">,</span> <span class="s2">&quot;drive_access&quot;</span><span class="p">],</span>
    <span class="s2">&quot;rail&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;rail_only&quot;</span><span class="p">],</span>
    <span class="s2">&quot;transit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;bus_only&quot;</span><span class="p">,</span> <span class="s2">&quot;rail_only&quot;</span><span class="p">,</span> <span class="s2">&quot;drive_access&quot;</span><span class="p">],</span>
    <span class="s2">&quot;walk&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;walk_access&quot;</span><span class="p">],</span>
    <span class="s2">&quot;bike&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;bike_access&quot;</span><span class="p">],</span>
<span class="p">}</span>

<span class="n">MODES_TO_NETWORK_NODE_VARIABLES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;drive&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;drive_access&quot;</span><span class="p">],</span>
    <span class="s2">&quot;rail&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;rail_only&quot;</span><span class="p">,</span> <span class="s2">&quot;drive_access&quot;</span><span class="p">],</span>
    <span class="s2">&quot;bus&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;bus_only&quot;</span><span class="p">,</span> <span class="s2">&quot;drive_access&quot;</span><span class="p">],</span>
    <span class="s2">&quot;transit&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;bus_only&quot;</span><span class="p">,</span> <span class="s2">&quot;rail_only&quot;</span><span class="p">,</span> <span class="s2">&quot;drive_access&quot;</span><span class="p">],</span>
    <span class="s2">&quot;walk&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;walk_node&quot;</span><span class="p">],</span>
    <span class="s2">&quot;bike&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;bike_node&quot;</span><span class="p">],</span>
<span class="p">}</span>

<span class="c1"># Primary keys used in graph creation</span>
<span class="n">UNIQUE_LINK_KEY</span> <span class="o">=</span> <span class="s2">&quot;model_link_id&quot;</span>
<span class="n">UNIQUE_NODE_KEY</span> <span class="o">=</span> <span class="s2">&quot;model_node_id&quot;</span>

<span class="c1"># Shortest Path settings for finding routes</span>
<span class="n">SEARCH_BREADTH</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">MAX_SEARCH_BREADTH</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">SP_WEIGHT_FACTOR</span> <span class="o">=</span> <span class="mi">100</span>


<span class="k">class</span> <span class="nc">NoPathFound</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when can&#39;t find path.&quot;&quot;&quot;</span>

    <span class="k">pass</span>


<div class="viewcode-block" id="RoadwayNetwork"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork">[docs]</a><span class="k">class</span> <span class="nc">RoadwayNetwork</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Representation of a Roadway Network.</span>

<span class="sd">    .. highlight:: python</span>

<span class="sd">    Typical usage example:</span>
<span class="sd">    ::</span>

<span class="sd">        net = RoadwayNetwork.read(</span>
<span class="sd">            link_filename=MY_LINK_FILE,</span>
<span class="sd">            node_filename=MY_NODE_FILE,</span>
<span class="sd">            shape_filename=MY_SHAPE_FILE,</span>
<span class="sd">            shape_foreign_key =&#39;shape_id&#39;,</span>
<span class="sd">        )</span>
<span class="sd">        my_selection = {</span>
<span class="sd">            &quot;link&quot;: [{&quot;name&quot;: [&quot;I 35E&quot;]}],</span>
<span class="sd">            &quot;A&quot;: {&quot;osm_node_id&quot;: &quot;961117623&quot;},  # start searching for segments at A</span>
<span class="sd">            &quot;B&quot;: {&quot;osm_node_id&quot;: &quot;2564047368&quot;},</span>
<span class="sd">        }</span>
<span class="sd">        net.select_roadway_features(my_selection)</span>

<span class="sd">        my_change = [</span>
<span class="sd">            {</span>
<span class="sd">                &#39;property&#39;: &#39;lanes&#39;,</span>
<span class="sd">                &#39;existing&#39;: 1,</span>
<span class="sd">                &#39;set&#39;: 2,</span>
<span class="sd">             },</span>
<span class="sd">             {</span>
<span class="sd">                &#39;property&#39;: &#39;drive_access&#39;,</span>
<span class="sd">                &#39;set&#39;: 0,</span>
<span class="sd">              },</span>
<span class="sd">        ]</span>

<span class="sd">        my_net.apply_roadway_feature_change(</span>
<span class="sd">            my_net.select_roadway_features(my_selection),</span>
<span class="sd">            my_change</span>
<span class="sd">        )</span>

<span class="sd">        ml_net = net.create_managed_lane_network(in_place=False)</span>
<span class="sd">        ml_net.is_network_connected(mode=&quot;drive&quot;))</span>
<span class="sd">        _, disconnected_nodes = ml_net.assess_connectivity(mode=&quot;walk&quot;, ignore_end_nodes=True)</span>
<span class="sd">        ml_net.write(filename=my_out_prefix, path=my_dir)</span>

<span class="sd">    Attributes:</span>
<span class="sd">        nodes_df (GeoDataFrame): node data</span>
<span class="sd">        links_df (GeoDataFrame): link data, including start and end</span>
<span class="sd">            nodes and associated shape</span>
<span class="sd">        shapes_df (GeoDataFrame): detailed shape data</span>
<span class="sd">        crs (int): coordinate reference system, ESPG number</span>
<span class="sd">        node_foreign_key (str):  variable linking the node table to the link table</span>
<span class="sd">        link_foreign_key (list): list of variable linking the link table to the node foreign key</span>
<span class="sd">        shape_foreign_key (str): variable linking the links table and shape table</span>
<span class="sd">        unique_link_ids (list): list of variables unique to each link</span>
<span class="sd">        unique_node_ids (list): list of variables unique to each node</span>
<span class="sd">        modes_to_network_link_variables (dict): Mapping of modes to link variables in the network</span>
<span class="sd">        modes_to_network_nodes_variables (dict): Mapping of modes to node variables in the network</span>
<span class="sd">        managed_lanes_node_id_scalar (int): Scalar values added to primary keys for nodes for</span>
<span class="sd">            corresponding managed lanes.</span>
<span class="sd">        managed_lanes_link_id_scalar (int): Scalar values added to primary keys for links for</span>
<span class="sd">            corresponding managed lanes.</span>
<span class="sd">        managed_lanes_required_attributes (list): attributes that must be specified in managed</span>
<span class="sd">            lane projects.</span>
<span class="sd">        keep_same_attributes_ml_and_gp (list): attributes to copy to managed lanes from parallel</span>
<span class="sd">            general purpose lanes.</span>

<span class="sd">        selections (dict): dictionary storing selections in case they are made repeatedly</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RoadwayNetwork.__init__"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">nodes</span><span class="p">:</span> <span class="n">GeoDataFrame</span><span class="p">,</span>
        <span class="n">links</span><span class="p">:</span> <span class="n">GeoDataFrame</span><span class="p">,</span>
        <span class="n">shapes</span><span class="p">:</span> <span class="n">GeoDataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">node_foreign_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">link_foreign_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">shape_foreign_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">unique_link_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">unique_node_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">unique_link_ids</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">unique_node_ids</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">crs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputs_valid</span> <span class="o">=</span> <span class="p">[</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">GeoDataFrame</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">links</span><span class="p">,</span> <span class="n">shapes</span><span class="p">)]</span>
        <span class="k">if</span> <span class="kc">False</span> <span class="ow">in</span> <span class="n">inputs_valid</span><span class="p">:</span>
            <span class="k">raise</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input nodes (</span><span class="si">{}</span><span class="s2">), links (</span><span class="si">{}</span><span class="s2">)or shapes (</span><span class="si">{}</span><span class="s2">) not of required type GeoDataFrame&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">inputs_valid</span><span class="p">)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span> <span class="o">=</span> <span class="n">links</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shapes_df</span> <span class="o">=</span> <span class="n">shapes</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span> <span class="o">=</span> <span class="n">NODE_FOREIGN_KEY</span> <span class="k">if</span> <span class="n">node_foreign_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">node_foreign_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link_foreign_key</span> <span class="o">=</span> <span class="n">LINK_FOREIGN_KEY</span> <span class="k">if</span> <span class="n">link_foreign_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">link_foreign_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span> <span class="o">=</span> <span class="n">SHAPE_FOREIGN_KEY</span> <span class="k">if</span> <span class="n">shape_foreign_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">shape_foreign_key</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unique_link_key</span> <span class="o">=</span> <span class="n">UNIQUE_LINK_KEY</span> <span class="k">if</span> <span class="n">unique_link_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">unique_link_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span> <span class="o">=</span> <span class="n">UNIQUE_NODE_KEY</span> <span class="k">if</span> <span class="n">unique_node_key</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">unique_node_key</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">unique_link_ids</span> <span class="o">=</span> <span class="n">UNIQUE_LINK_IDS</span> <span class="k">if</span> <span class="n">unique_link_ids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">unique_link_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique_node_ids</span> <span class="o">=</span> <span class="n">UNIQUE_NODE_IDS</span> <span class="k">if</span> <span class="n">unique_node_ids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">unique_node_ids</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">CRS</span> <span class="k">if</span> <span class="n">crs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">crs</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Add non-required fields if they aren&#39;t there.</span>
        <span class="c1"># for field, default_value in RoadwayNetwork.OPTIONAL_FIELDS:</span>
        <span class="c1">#    if field not in self.links_df.columns:</span>
        <span class="c1">#        self.links_df[field] = default_value</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">validate_uniqueness</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;IDs in network not unique&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selections</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="RoadwayNetwork.read"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.read">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span>
        <span class="n">link_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">node_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">shape_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">fast</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">crs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">CRS</span><span class="p">,</span>
        <span class="n">node_foreign_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">NODE_FOREIGN_KEY</span><span class="p">,</span>
        <span class="n">link_foreign_key</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">LINK_FOREIGN_KEY</span><span class="p">,</span>
        <span class="n">shape_foreign_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">SHAPE_FOREIGN_KEY</span><span class="p">,</span>
        <span class="n">unique_link_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">UNIQUE_LINK_KEY</span><span class="p">,</span>
        <span class="n">unique_node_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">UNIQUE_NODE_KEY</span><span class="p">,</span>
        <span class="n">unique_link_ids</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">UNIQUE_LINK_IDS</span><span class="p">,</span>
        <span class="n">unique_node_ids</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">UNIQUE_NODE_IDS</span><span class="p">,</span>
        <span class="n">modes_to_network_link_variables</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">MODES_TO_NETWORK_LINK_VARIABLES</span><span class="p">,</span>
        <span class="n">modes_to_network_nodes_variables</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">MODES_TO_NETWORK_NODE_VARIABLES</span><span class="p">,</span>
        <span class="n">managed_lanes_link_id_scalar</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">MANAGED_LANES_LINK_ID_SCALAR</span><span class="p">,</span>
        <span class="n">managed_lanes_node_id_scalar</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">MANAGED_LANES_NODE_ID_SCALAR</span><span class="p">,</span>
        <span class="n">managed_lanes_required_attributes</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">MANAGED_LANES_REQUIRED_ATTRIBUTES</span><span class="p">,</span>
        <span class="n">keep_same_attributes_ml_and_gp</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">KEEP_SAME_ATTRIBUTES_ML_AND_GP</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RoadwayNetwork</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads a network from the roadway network standard</span>
<span class="sd">        Validates that it conforms to the schema</span>

<span class="sd">        args:</span>
<span class="sd">            node_filename: full path to the node file</span>
<span class="sd">            link_filename: full path to the link file</span>
<span class="sd">            shape_filename: full path to the shape file</span>
<span class="sd">            fast: boolean that will skip validation to speed up read time</span>
<span class="sd">            crs: coordinate reference system, ESPG number</span>
<span class="sd">            node_foreign_key: variable linking the node table to the link table.</span>
<span class="sd">            link_foreign_key:</span>
<span class="sd">            shape_foreign_key:</span>
<span class="sd">            unique_link_ids:</span>
<span class="sd">            unique_node_ids:</span>
<span class="sd">            modes_to_network_link_variables:</span>
<span class="sd">            modes_to_network_nodes_variables:</span>
<span class="sd">            managed_lanes_node_id_scalar:</span>
<span class="sd">            managed_lanes_link_id_scalar:</span>
<span class="sd">            managed_lanes_required_attributes:</span>
<span class="sd">            keep_same_attributes_ml_and_gp:</span>

<span class="sd">        Returns: a RoadwayNetwork instance</span>

<span class="sd">        .. todo:: Turn off fast=True as default</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reading RoadwayNetwork&quot;</span><span class="p">)</span>

        <span class="n">nodes_df</span><span class="p">,</span><span class="n">links_df</span><span class="p">,</span><span class="n">shapes_df</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">load_transform_network</span><span class="p">(</span>
            <span class="n">node_filename</span><span class="p">,</span>
            <span class="n">link_filename</span><span class="p">,</span>
            <span class="n">shape_filename</span><span class="p">,</span>
            <span class="n">crs</span> <span class="o">=</span> <span class="n">crs</span><span class="p">,</span>
            <span class="n">node_foreign_key</span> <span class="o">=</span> <span class="n">node_foreign_key</span><span class="p">,</span>
            <span class="n">validate_schema</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">fast</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">roadway_network</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="p">(</span>
            <span class="n">nodes</span><span class="o">=</span><span class="n">nodes_df</span><span class="p">,</span>
            <span class="n">links</span><span class="o">=</span><span class="n">links_df</span><span class="p">,</span>
            <span class="n">shapes</span><span class="o">=</span><span class="n">shapes_df</span><span class="p">,</span>
            <span class="n">crs</span><span class="o">=</span><span class="n">crs</span><span class="p">,</span>
            <span class="n">node_foreign_key</span><span class="o">=</span><span class="n">node_foreign_key</span><span class="p">,</span>
            <span class="n">link_foreign_key</span><span class="o">=</span><span class="n">link_foreign_key</span><span class="p">,</span>
            <span class="n">shape_foreign_key</span><span class="o">=</span><span class="n">shape_foreign_key</span><span class="p">,</span>
            <span class="n">unique_link_ids</span><span class="o">=</span><span class="n">unique_link_ids</span><span class="p">,</span>
            <span class="n">unique_node_ids</span><span class="o">=</span><span class="n">unique_node_ids</span><span class="p">,</span>
            <span class="n">unique_link_key</span><span class="o">=</span><span class="n">unique_link_key</span><span class="p">,</span>
            <span class="n">unique_node_key</span><span class="o">=</span><span class="n">unique_node_key</span><span class="p">,</span>
            <span class="n">modes_to_network_link_variables</span><span class="o">=</span><span class="n">modes_to_network_link_variables</span><span class="p">,</span>
            <span class="n">modes_to_network_nodes_variables</span><span class="o">=</span><span class="n">modes_to_network_nodes_variables</span><span class="p">,</span>
            <span class="n">link_filename</span> <span class="o">=</span> <span class="n">link_filename</span><span class="p">,</span>
            <span class="n">node_filename</span> <span class="o">=</span> <span class="n">node_filename</span><span class="p">,</span>
            <span class="n">shape_filename</span> <span class="o">=</span> <span class="n">shape_filename</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">roadway_network</span></div>

<div class="viewcode-block" id="RoadwayNetwork.load_transform_network"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.load_transform_network">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">load_transform_network</span><span class="p">(</span>
        <span class="n">node_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">link_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">shape_filename</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">crs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">CRS</span><span class="p">,</span>
        <span class="n">node_foreign_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">NODE_FOREIGN_KEY</span><span class="p">,</span>
        <span class="n">validate_schema</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads roadway network files from disk and transforms them into GeoDataFrames.</span>

<span class="sd">        args:</span>
<span class="sd">            node_filename: file name for nodes.</span>
<span class="sd">            link_filename: file name for links.</span>
<span class="sd">            shape_filename: file name for shapes.</span>
<span class="sd">            crs: coordinate reference system. Defaults to value in CRS.</span>
<span class="sd">            node_foreign_key: variable linking the node table to the link table. Defaults</span>
<span class="sd">                to NODE_FOREIGN_KEY.</span>
<span class="sd">            validate_schema: boolean indicating if network should be validated to schema.</span>

<span class="sd">        returns: tuple of GeodataFrames nodes_df, links_df, shapes_df</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Reading RoadwayNetwork from following files:</span><span class="se">\n</span><span class="s2">   -</span><span class="si">{}</span><span class="se">\n</span><span class="s2">   -</span><span class="si">{}</span><span class="se">\n</span><span class="s2">   -</span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">link_filename</span><span class="p">,</span> <span class="n">node_filename</span><span class="p">,</span> <span class="n">shape_filename</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">validate_schema</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span>
                <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">validate_node_schema</span><span class="p">(</span><span class="n">node_filename</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">validate_link_schema</span><span class="p">(</span><span class="n">link_filename</span><span class="p">)</span>
                <span class="ow">and</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">validate_shape_schema</span><span class="p">(</span><span class="n">shape_filename</span><span class="p">)</span>
            <span class="p">):</span>

                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;RoadwayNetwork: Data doesn&#39;t conform to schema&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">link_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">link_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">link_properties</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">link_json</span><span class="p">)</span>
        <span class="n">link_geometries</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">create_line_string</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">link_json</span>
        <span class="p">]</span>
        <span class="n">links_df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">link_properties</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">link_geometries</span><span class="p">)</span>

        <span class="n">links_df</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">crs</span>
        <span class="c1"># coerce types for booleans which might not have a 1 and are therefore read in as intersection</span>
        <span class="n">bool_columns</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;rail_only&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bus_only&quot;</span><span class="p">,</span>
            <span class="s2">&quot;drive_access&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bike_access&quot;</span><span class="p">,</span>
            <span class="s2">&quot;walk_access&quot;</span><span class="p">,</span>
            <span class="s2">&quot;truck_access&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">bc</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">bool_columns</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
            <span class="n">links_df</span><span class="p">[</span><span class="n">bc</span><span class="p">]</span> <span class="o">=</span> <span class="n">links_df</span><span class="p">[</span><span class="n">bc</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>

        <span class="n">shapes_df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">read_file</span><span class="p">(</span><span class="n">shape_filename</span><span class="p">)</span>
        <span class="n">shapes_df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">shapes_df</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">crs</span>

        <span class="c1"># geopandas uses fiona OGR drivers, which doesn&#39;t let you have</span>
        <span class="c1"># a list as a property type. Therefore, must read in node_properties</span>
        <span class="c1"># separately in a vanilla dataframe and then convert to geopandas</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">node_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">node_geojson</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">node_properties_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">node_geojson</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">node_foreign_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node_properties_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Specified `node_foreign_key`: </span><span class="si">{}</span><span class="s2"> not found in </span><span class="si">{}</span><span class="s2">. Available properties: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">node_foreign_key</span><span class="p">,</span>
                <span class="n">node_filename</span><span class="p">,</span>
                <span class="n">node_properties_df</span><span class="o">.</span><span class="n">columns</span>
            <span class="p">))</span>

        <span class="n">node_geometries</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Point</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">][</span><span class="s2">&quot;coordinates&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">node_geojson</span><span class="p">[</span><span class="s2">&quot;features&quot;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="n">nodes_df</span> <span class="o">=</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">node_properties_df</span><span class="p">,</span> <span class="n">geometry</span><span class="o">=</span><span class="n">node_geometries</span><span class="p">)</span>

        <span class="n">nodes_df</span><span class="o">.</span><span class="n">gdf_name</span> <span class="o">=</span> <span class="s2">&quot;network_nodes&quot;</span>

        <span class="c1"># set a copy of the  foreign key to be the index so that the</span>
        <span class="c1"># variable itself remains queryiable</span>
        <span class="n">nodes_df</span><span class="p">[</span><span class="n">node_foreign_key</span> <span class="o">+</span> <span class="s2">&quot;_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes_df</span><span class="p">[</span><span class="n">node_foreign_key</span><span class="p">]</span>
        <span class="n">nodes_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">node_foreign_key</span> <span class="o">+</span> <span class="s2">&quot;_idx&quot;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">nodes_df</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="n">crs</span>
        <span class="n">nodes_df</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">nodes_df</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read </span><span class="si">%s</span><span class="s2"> links from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">links_df</span><span class="p">),</span> <span class="n">link_filename</span><span class="p">))</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read </span><span class="si">%s</span><span class="s2"> nodes from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nodes_df</span><span class="p">),</span> <span class="n">node_filename</span><span class="p">))</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Read </span><span class="si">%s</span><span class="s2"> shapes from </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">shapes_df</span><span class="p">),</span> <span class="n">shape_filename</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">nodes_df</span><span class="p">,</span> <span class="n">links_df</span><span class="p">,</span> <span class="n">shapes_df</span></div>


<div class="viewcode-block" id="RoadwayNetwork.write"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Writes a network in the roadway network standard</span>

<span class="sd">        args:</span>
<span class="sd">            path: the path were the output will be saved</span>
<span class="sd">            filename: the name prefix of the roadway files that will be generated</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Path [</span><span class="si">%s</span><span class="s2">] doesn&#39;t exist; creating.&quot;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="n">links_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;link.json&quot;</span><span class="p">)</span>
            <span class="n">nodes_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;node.geojson&quot;</span><span class="p">)</span>
            <span class="n">shapes_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;shape.geojson&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">links_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;link.json&quot;</span><span class="p">)</span>
            <span class="n">nodes_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;node.geojson&quot;</span><span class="p">)</span>
            <span class="n">shapes_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;shape.geojson&quot;</span><span class="p">)</span>

        <span class="n">link_property_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">link_property_columns</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;geometry&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        links_json = link_df_to_json(self.links_df, link_property_columns)</span>
<span class="sd">        with open(links_file, &quot;w&quot;) as f:</span>
<span class="sd">            json.dump(links_json, f)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">links_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">link_property_columns</span><span class="p">]</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">orient</span> <span class="o">=</span> <span class="s2">&quot;records&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">links_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">links_json</span><span class="p">)</span>

        <span class="c1"># geopandas wont let you write to geojson because</span>
        <span class="c1"># it uses fiona, which doesn&#39;t accept a list as one of the properties</span>
        <span class="c1"># so need to convert the df to geojson manually first</span>
        <span class="n">property_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">property_columns</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;geometry&quot;</span><span class="p">)</span>

        <span class="n">nodes_geojson</span> <span class="o">=</span> <span class="n">point_df_to_geojson</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">,</span> <span class="n">property_columns</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">nodes_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">nodes_geojson</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shapes_df</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">shapes_file</span><span class="p">,</span> <span class="n">driver</span><span class="o">=</span><span class="s2">&quot;GeoJSON&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RoadwayNetwork.roadway_net_to_gdf"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.roadway_net_to_gdf">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">roadway_net_to_gdf</span><span class="p">(</span><span class="n">roadway_net</span><span class="p">:</span> <span class="n">RoadwayNetwork</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Turn the roadway network into a GeoDataFrame</span>
<span class="sd">        args:</span>
<span class="sd">            roadway_net: the roadway network to export</span>

<span class="sd">        returns: shapes dataframe</span>

<span class="sd">        .. todo:: Make this much more sophisticated, for example attach link info to shapes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">roadway_net</span><span class="o">.</span><span class="n">shapes_df</span></div>

<div class="viewcode-block" id="RoadwayNetwork.validate_uniqueness"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.validate_uniqueness">[docs]</a>    <span class="k">def</span> <span class="nf">validate_uniqueness</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Confirms that the unique identifiers are met.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_link_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Network doesn&#39;t contain unique link identifier: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unique identifier </span><span class="si">{}</span><span class="s2"> is not unique in network links&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_foreign_key</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Network doesn&#39;t contain link foreign key identifier: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">c</span>
                <span class="p">)</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">link_foreign_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">link_foreign_key</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">link_foreign_key</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Foreign key: </span><span class="si">{}</span><span class="s2"> is not unique in network links&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">link_foreign_key</span>
            <span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_node_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Network doesn&#39;t contain unique node identifier: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unique identifier </span><span class="si">{}</span><span class="s2"> is not unique in network nodes&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Network doesn&#39;t contain node foreign key identifier: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span>
            <span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span><span class="p">]</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Foreign key: </span><span class="si">{}</span><span class="s2"> is not unique in network nodes&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span>
            <span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Network doesn&#39;t contain unique shape id: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span>
            <span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span><span class="p">]</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Unique key: </span><span class="si">{}</span><span class="s2"> is not unique in network shapes&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span>
            <span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">valid</span></div>

<div class="viewcode-block" id="RoadwayNetwork.validate_node_schema"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.validate_node_schema">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">validate_node_schema</span><span class="p">(</span>
        <span class="n">node_file</span><span class="p">,</span> <span class="n">schema_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;roadway_network_node.json&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate roadway network data node schema and output a boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">schema_location</span><span class="p">):</span>
            <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s2">&quot;schemas&quot;</span>
            <span class="p">)</span>
            <span class="n">schema_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">schema_location</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">schema_location</span><span class="p">)</span> <span class="k">as</span> <span class="n">schema_json_file</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">schema_json_file</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">node_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">node_json_file</span><span class="p">:</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">node_json_file</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">validate</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed Node schema validation: Validation Error&quot;</span><span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Node File Loc:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_file</span><span class="p">))</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Node Schema Loc:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schema_location</span><span class="p">))</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">SchemaError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid Node Schema&quot;</span><span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Node Schema Loc:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schema_location</span><span class="p">))</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="RoadwayNetwork.validate_link_schema"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.validate_link_schema">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">validate_link_schema</span><span class="p">(</span>
        <span class="n">link_filename</span><span class="p">,</span> <span class="n">schema_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;roadway_network_link.json&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate roadway network data link schema and output a boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">schema_location</span><span class="p">):</span>
            <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s2">&quot;schemas&quot;</span>
            <span class="p">)</span>
            <span class="n">schema_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">schema_location</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">schema_location</span><span class="p">)</span> <span class="k">as</span> <span class="n">schema_json_file</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">schema_json_file</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">link_filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">link_json_file</span><span class="p">:</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">link_json_file</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">validate</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed Link schema validation: Validation Error&quot;</span><span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Link File Loc:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">link_filename</span><span class="p">))</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Path:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">SchemaError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid Link Schema&quot;</span><span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Link Schema Loc: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schema_location</span><span class="p">))</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="RoadwayNetwork.validate_shape_schema"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.validate_shape_schema">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">validate_shape_schema</span><span class="p">(</span>
        <span class="n">shape_file</span><span class="p">,</span> <span class="n">schema_location</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;roadway_network_shape.json&quot;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Validate roadway network data shape schema and output a boolean</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">schema_location</span><span class="p">):</span>
            <span class="n">base_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s2">&quot;schemas&quot;</span>
            <span class="p">)</span>
            <span class="n">schema_location</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_path</span><span class="p">,</span> <span class="n">schema_location</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">schema_location</span><span class="p">)</span> <span class="k">as</span> <span class="n">schema_json_file</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">schema_json_file</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">shape_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">shape_json_file</span><span class="p">:</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">shape_json_file</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">validate</span><span class="p">(</span><span class="n">json_data</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed Shape schema validation: Validation Error&quot;</span><span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Shape File Loc:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shape_file</span><span class="p">))</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Path:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">path</span><span class="p">))</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

        <span class="k">except</span> <span class="n">SchemaError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Invalid Shape Schema&quot;</span><span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Shape Schema Loc: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">schema_location</span><span class="p">))</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">message</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="RoadwayNetwork.validate_selection"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.validate_selection">[docs]</a>    <span class="k">def</span> <span class="nf">validate_selection</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">selection_requires</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">SELECTION_REQUIRES</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluate whetther the selection dictionary contains the</span>
<span class="sd">        minimum required values.</span>

<span class="sd">        Args:</span>
<span class="sd">            selection: selection dictionary to be evaluated</span>

<span class="sd">        Returns: boolean value as to whether the selection dictonary is valid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">selection_requires</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">selection</span><span class="p">):</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;Project Card Selection requires: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">selection_requires</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">+=</span> <span class="s2">&quot;, but selection only contains: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">selection</span><span class="p">))</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span>

        <span class="n">err</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">[</span><span class="s2">&quot;link&quot;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">err</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> specified in link selection but not an attribute in network</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">k</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
        <span class="n">selection_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">[</span><span class="s2">&quot;link&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="n">unique_link_id</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_link_ids</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">selection_keys</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">unique_link_id</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span><span class="p">:</span>
                    <span class="n">err</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> specified in A node selection but not an attribute in network</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">k</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span><span class="p">:</span>
                    <span class="n">err</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> specified in B node selection but not an attribute in network</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">k</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;ERROR: Selection variables in project card not found in network&quot;</span>
            <span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;--existing node columns:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s2">&quot;--existing link columns:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="RoadwayNetwork.orig_dest_nodes_foreign_key"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.orig_dest_nodes_foreign_key">[docs]</a>    <span class="k">def</span> <span class="nf">orig_dest_nodes_foreign_key</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">selection</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">node_foreign_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the foreign key id (whatever is used in the u and v</span>
<span class="sd">        variables in the links file) for the AB nodes as a tuple.</span>

<span class="sd">        Args:</span>
<span class="sd">            selection : selection dictionary with A and B keys</span>
<span class="sd">            node_foreign_key: variable name for whatever is used by the u and v variable</span>
<span class="sd">            in the links_df file.  If nothing is specified, assume whatever</span>
<span class="sd">            default is (usually osm_node_id)</span>

<span class="sd">        Returns: tuple of (A_id, B_id)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">node_foreign_key</span><span class="p">:</span>
            <span class="n">node_foreign_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;Selection A node dictionary should be of length 1&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="p">(</span><span class="s2">&quot;Selection B node dictionary should be of length 1&quot;</span><span class="p">)</span>

        <span class="n">A_node_key</span><span class="p">,</span> <span class="n">A_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">selection</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="n">B_node_key</span><span class="p">,</span> <span class="n">B_id</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">selection</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>

        <span class="k">if</span> <span class="n">A_node_key</span> <span class="o">!=</span> <span class="n">node_foreign_key</span><span class="p">:</span>
            <span class="n">A_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="n">A_node_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">A_id</span><span class="p">][</span>
                <span class="n">node_foreign_key</span>
            <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">B_node_key</span> <span class="o">!=</span> <span class="n">node_foreign_key</span><span class="p">:</span>
            <span class="n">B_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="n">B_node_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">B_id</span><span class="p">][</span>
                <span class="n">node_foreign_key</span>
            <span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">A_id</span><span class="p">,</span> <span class="n">B_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="RoadwayNetwork.get_managed_lane_node_ids"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.get_managed_lane_node_ids">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_managed_lane_node_ids</span><span class="p">(</span>
        <span class="n">nodes_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">scalar</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">MANAGED_LANES_NODE_ID_SCALAR</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform a list of node IDS by a scalar.</span>
<span class="sd">        ..todo #237 what if node ids are not a number?</span>

<span class="sd">        Args:</span>
<span class="sd">            nodes_list: list of integers</span>
<span class="sd">            scalar: value to add to node IDs</span>

<span class="sd">        Returns: list of integers</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">scalar</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">nodes_list</span><span class="p">]</span></div>

<div class="viewcode-block" id="RoadwayNetwork.ox_graph"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.ox_graph">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">ox_graph</span><span class="p">(</span>
        <span class="n">nodes_df</span><span class="p">:</span> <span class="n">GeoDataFrame</span><span class="p">,</span>
        <span class="n">links_df</span><span class="p">:</span> <span class="n">GeoDataFrame</span><span class="p">,</span>
        <span class="n">node_foreign_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">NODE_FOREIGN_KEY</span><span class="p">,</span>
        <span class="n">link_foreign_key</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">LINK_FOREIGN_KEY</span><span class="p">,</span>
        <span class="n">unique_link_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">UNIQUE_LINK_KEY</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create an osmnx-flavored network graph</span>

<span class="sd">        osmnx doesn&#39;t like values that are arrays, so remove the variables</span>
<span class="sd">        that have arrays.  osmnx also requires that certain variables</span>
<span class="sd">        be filled in, so do that too.</span>

<span class="sd">        Args:</span>
<span class="sd">            nodes_df : GeoDataFrame of nodes</span>
<span class="sd">            link_df : GeoDataFrame of links</span>
<span class="sd">            node_foreign_key: field referenced in `link_foreign_key`</span>
<span class="sd">            link_foreign_key: list of attributes that define the link start and end nodes to the node foreign key</span>
<span class="sd">            unique_link_key: primary key for links</span>

<span class="sd">        Returns: a networkx multidigraph</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;starting ox_graph()&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;inboundReferenceIds&quot;</span> <span class="ow">in</span> <span class="n">nodes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">graph_nodes</span> <span class="o">=</span> <span class="n">nodes_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;inboundReferenceIds&quot;</span><span class="p">,</span> <span class="s2">&quot;outboundReferenceIds&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">graph_nodes</span> <span class="o">=</span> <span class="n">nodes_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">graph_nodes</span><span class="o">.</span><span class="n">gdf_name</span> <span class="o">=</span> <span class="s2">&quot;network_nodes&quot;</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;GRAPH NODES: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">graph_nodes</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
        <span class="n">graph_nodes</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph_nodes</span><span class="p">[</span><span class="n">node_foreign_key</span><span class="p">]</span>

        <span class="n">graph_nodes</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph_nodes</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span>
        <span class="n">graph_nodes</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph_nodes</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s2">&quot;osm_link_id&quot;</span> <span class="ow">in</span> <span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">graph_links</span> <span class="o">=</span> <span class="n">links_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;osm_link_id&quot;</span><span class="p">,</span> <span class="s2">&quot;locationReferences&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">graph_links</span> <span class="o">=</span> <span class="n">links_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>

        <span class="c1"># have to change this over into u,v b/c this is what osm-nx is expecting</span>
        <span class="n">graph_links</span><span class="p">[</span><span class="s2">&quot;u&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph_links</span><span class="p">[</span><span class="n">link_foreign_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">graph_links</span><span class="p">[</span><span class="s2">&quot;v&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph_links</span><span class="p">[</span><span class="n">link_foreign_key</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">graph_links</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph_links</span><span class="p">[</span><span class="n">unique_link_key</span><span class="p">]</span>
        <span class="n">graph_links</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">graph_links</span><span class="p">[</span><span class="n">unique_link_key</span><span class="p">]</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;starting ox.gdfs_to_graph()&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ox</span><span class="o">.</span><span class="n">__version__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># index required in newer osmnx</span>
                <span class="n">graph_links</span> <span class="o">=</span> <span class="n">graph_links</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="s2">&quot;key&quot;</span><span class="p">])</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">graph_from_gdfs</span><span class="p">(</span><span class="n">graph_nodes</span><span class="p">,</span> <span class="n">graph_links</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Please upgrade your OSMNX package. For now, using depricated osmnx.gdfs_to_graph because osmnx.graph_from_gdfs not found&quot;</span>
            <span class="p">)</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">gdfs_to_graph</span><span class="p">(</span><span class="n">graph_nodes</span><span class="p">,</span> <span class="n">graph_links</span><span class="p">)</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;finished ox.gdfs_to_graph()&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">G</span></div>

<div class="viewcode-block" id="RoadwayNetwork.selection_has_unique_link_id"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.selection_has_unique_link_id">[docs]</a>    <span class="k">def</span> <span class="nf">selection_has_unique_link_id</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selection_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            selection_dictionary: Dictionary representation of selection</span>
<span class="sd">                of roadway features, containing a &quot;link&quot; key.</span>

<span class="sd">        Returns: A boolean indicating if the selection dictionary contains</span>
<span class="sd">            a unique identifier for links.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">selection_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">selection_dict</span><span class="p">[</span><span class="s2">&quot;link&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">l</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_link_ids</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">selection_keys</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="RoadwayNetwork.build_selection_key"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.build_selection_key">[docs]</a>    <span class="k">def</span> <span class="nf">build_selection_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selection_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Selections are stored by a key combining the query and the A and B ids.</span>
<span class="sd">        This method combines the two for you based on the selection dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            selection_dictonary: Selection Dictionary</span>

<span class="sd">        Returns: Tuple serving as the selection key.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sel_query</span> <span class="o">=</span> <span class="n">ProjectCard</span><span class="o">.</span><span class="n">build_link_selection_query</span><span class="p">(</span>
            <span class="n">selection</span><span class="o">=</span><span class="n">selection_dict</span><span class="p">,</span>
            <span class="n">unique_link_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_link_ids</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_has_unique_link_id</span><span class="p">(</span><span class="n">selection_dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">sel_query</span>

        <span class="n">A_id</span><span class="p">,</span> <span class="n">B_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_dest_nodes_foreign_key</span><span class="p">(</span><span class="n">selection_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">sel_query</span><span class="p">,</span> <span class="n">A_id</span><span class="p">,</span> <span class="n">B_id</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_fk_nodes</span><span class="p">(</span>
        <span class="n">_links</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span> <span class="n">link_foreign_key</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">LINK_FOREIGN_KEY</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Find the nodes for the candidate links.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_n</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">link_foreign_key</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">_links</span><span class="p">[</span><span class="n">fk</span><span class="p">])]))</span>
        <span class="c1"># WranglerLogger.debug(&quot;Node foreign key list: {}&quot;.format(_n))</span>
        <span class="k">return</span> <span class="n">_n</span>

<div class="viewcode-block" id="RoadwayNetwork.shortest_path"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.shortest_path">[docs]</a>    <span class="k">def</span> <span class="nf">shortest_path</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">graph_links_df</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span>
        <span class="n">O_id</span><span class="p">,</span>
        <span class="n">D_id</span><span class="p">,</span>
        <span class="n">nodes_df</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">weight_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span>
        <span class="n">weight_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">SP_WEIGHT_FACTOR</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            graph_links_df:</span>
<span class="sd">            O_id: foreign key for start node</span>
<span class="sd">            D_id: foreign key for end node</span>
<span class="sd">            nodes_df: optional nodes df, otherwise will use network instance</span>
<span class="sd">            weight_column: column to use as a weight, defaults to &quot;i&quot;</span>
<span class="sd">            weight_factor: any additional weighting to multiply the weight column by, defaults to SP_WEIGHT_FACTOR</span>

<span class="sd">        Returns: tuple with length of four</span>
<span class="sd">        - Boolean if shortest path found</span>
<span class="sd">        - nx Directed graph of graph links</span>
<span class="sd">        - route of shortest path nodes as List</span>
<span class="sd">        - links in shortest path selected from links_df</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Calculating shortest path from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> using </span><span class="si">{}</span><span class="s2"> as weight with a factor of </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">O_id</span><span class="p">,</span> <span class="n">D_id</span><span class="p">,</span> <span class="n">weight_column</span><span class="p">,</span> <span class="n">weight_factor</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Prep Graph Links</span>
        <span class="k">if</span> <span class="n">weight_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">graph_links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> not in graph_links_df so adding and initializing to 1.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">weight_column</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">graph_links_df</span><span class="p">[</span><span class="n">weight_column</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">graph_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span>
            <span class="n">graph_links_df</span><span class="p">[</span><span class="n">weight_column</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight_factor</span>
        <span class="p">)</span>

        <span class="c1"># Select Graph Nodes</span>
        <span class="n">node_list_foreign_keys</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">_get_fk_nodes</span><span class="p">(</span>
            <span class="n">graph_links_df</span><span class="p">,</span> <span class="n">link_foreign_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">link_foreign_key</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">O_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node_list_foreign_keys</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;O_id: </span><span class="si">{}</span><span class="s2"> not in Graph for finding shortest Path&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">O_id</span><span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">D_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node_list_foreign_keys</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;D_id: </span><span class="si">{}</span><span class="s2"> not in Graph for finding shortest Path&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">D_id</span><span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">nodes_df</span><span class="p">:</span>
            <span class="n">nodes_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span>
        <span class="n">graph_nodes_df</span> <span class="o">=</span> <span class="n">nodes_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">node_list_foreign_keys</span><span class="p">]</span>

        <span class="c1"># Create Graph</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating network graph&quot;</span><span class="p">)</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">ox_graph</span><span class="p">(</span>
            <span class="n">graph_nodes_df</span><span class="p">,</span>
            <span class="n">graph_links_df</span><span class="p">,</span>
            <span class="n">node_foreign_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span><span class="p">,</span>
            <span class="n">link_foreign_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">link_foreign_key</span><span class="p">,</span>
            <span class="n">unique_link_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_link_key</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">sp_route</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">O_id</span><span class="p">,</span> <span class="n">D_id</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s2">&quot;weight&quot;</span><span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Shortest path successfully routed&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">nx</span><span class="o">.</span><span class="n">NetworkXNoPath</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No SP from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> Found.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">O_id</span><span class="p">,</span> <span class="n">D_id</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">graph_links_df</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">sp_links</span> <span class="o">=</span> <span class="n">graph_links_df</span><span class="p">[</span>
            <span class="n">graph_links_df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sp_route</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">graph_links_df</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sp_route</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">graph_links_df</span><span class="p">,</span> <span class="n">sp_route</span><span class="p">,</span> <span class="n">sp_links</span></div>

<div class="viewcode-block" id="RoadwayNetwork.path_search"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.path_search">[docs]</a>    <span class="k">def</span> <span class="nf">path_search</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">candidate_links_df</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span>
        <span class="n">O_id</span><span class="p">,</span>
        <span class="n">D_id</span><span class="p">,</span>
        <span class="n">weight_column</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span>
        <span class="n">weight_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">search_breadth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">SEARCH_BREADTH</span><span class="p">,</span>
        <span class="n">max_search_breadth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">MAX_SEARCH_BREADTH</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            candidate_links: selection of links geodataframe with links likely to be part of path</span>
<span class="sd">            O_id: origin node foreigh key ID</span>
<span class="sd">            D_id: destination node foreigh key ID</span>
<span class="sd">            weight_column: column to use for weight of shortest path. Defaults to &quot;i&quot; (iteration)</span>
<span class="sd">            weight_factor: optional weight to multiply the weight column by when finding the shortest path</span>
<span class="sd">            search_breadth:</span>

<span class="sd">        Returns</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_add_breadth</span><span class="p">(</span>
            <span class="n">_candidate_links_df</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span>
            <span class="n">_nodes_df</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span>
            <span class="n">_links_df</span><span class="p">:</span> <span class="n">gpd</span><span class="o">.</span><span class="n">GeoDataFrame</span><span class="p">,</span>
            <span class="n">i</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Add outbound and inbound reference IDs to candidate links</span>
<span class="sd">            from existing nodes</span>

<span class="sd">            Args:</span>
<span class="sd">                _candidate_links_df : df with the links from the previous iteration</span>
<span class="sd">                _nodes_df : df of all nodes in the full network</span>
<span class="sd">                _links_df : df of all links in the full network</span>
<span class="sd">                i : iteration of adding breadth</span>

<span class="sd">            Returns:</span>
<span class="sd">                candidate_links : GeoDataFrame</span>
<span class="sd">                    updated df with one more degree of added breadth</span>

<span class="sd">                node_list_foreign_keys : list of foreign key ids for nodes in the updated candidate links</span>
<span class="sd">                    to test if the A and B nodes are in there.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;-Adding Breadth-&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;i not specified in _add_breadth, using 1&quot;</span><span class="p">)</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">_candidate_nodes_df</span> <span class="o">=</span> <span class="n">_nodes_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">_get_fk_nodes</span><span class="p">(</span>
                    <span class="n">_candidate_links_df</span><span class="p">,</span> <span class="n">link_foreign_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">link_foreign_key</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Candidate Nodes: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_candidate_nodes_df</span><span class="p">)))</span>

            <span class="c1"># Identify links to add based on outbound and inbound links from nodes</span>
            <span class="n">_links_shstRefId_to_add</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span>
                    <span class="nb">sum</span><span class="p">(</span><span class="n">_candidate_nodes_df</span><span class="p">[</span><span class="s2">&quot;outboundReferenceIds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="p">[])</span>
                    <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="n">_candidate_nodes_df</span><span class="p">[</span><span class="s2">&quot;inboundReferenceIds&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="p">[])</span>
                <span class="p">)</span>
                <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">_candidate_links_df</span><span class="p">[</span><span class="s2">&quot;shstReferenceId&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="s2">&quot;&quot;</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">_links_to_add_df</span> <span class="o">=</span> <span class="n">_links_df</span><span class="p">[</span>
                <span class="n">_links_df</span><span class="o">.</span><span class="n">shstReferenceId</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">_links_shstRefId_to_add</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding </span><span class="si">{}</span><span class="s2"> links.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_links_to_add_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

            <span class="c1"># Add information about what iteration the link was added in</span>
            <span class="n">_links_df</span><span class="p">[</span><span class="n">_links_df</span><span class="o">.</span><span class="n">model_link_id</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">_links_shstRefId_to_add</span><span class="p">)][</span><span class="s2">&quot;i&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

            <span class="c1"># Append links and update node list</span>
            <span class="n">_candidate_links_df</span> <span class="o">=</span> <span class="n">_candidate_links_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_links_to_add_df</span><span class="p">)</span>
            <span class="n">_node_list_foreign_keys</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">_get_fk_nodes</span><span class="p">(</span>
                <span class="n">_candidate_links_df</span><span class="p">,</span> <span class="n">link_foreign_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">link_foreign_key</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">_candidate_links_df</span><span class="p">,</span> <span class="n">_node_list_foreign_keys</span>

        <span class="c1"># -----------------------------------</span>
        <span class="c1"># Set search breadth to zero + set max</span>
        <span class="c1"># -----------------------------------</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">max_i</span> <span class="o">=</span> <span class="n">search_breadth</span>
        <span class="c1"># -----------------------------------</span>
        <span class="c1"># Add links to the graph until</span>
        <span class="c1">#   (i) the A and B nodes are in the</span>
        <span class="c1">#       foreign key list</span>
        <span class="c1">#          - OR -</span>
        <span class="c1">#   (ii) reach maximum search breadth</span>
        <span class="c1"># -----------------------------------</span>
        <span class="n">node_list_foreign_keys</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">_get_fk_nodes</span><span class="p">(</span>
            <span class="n">candidate_links_df</span><span class="p">,</span> <span class="n">link_foreign_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">link_foreign_key</span>
        <span class="p">)</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Initial set of nodes: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">node_list_foreign_keys</span><span class="p">))</span>
        <span class="k">while</span> <span class="p">(</span>
            <span class="n">O_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node_list_foreign_keys</span> <span class="ow">or</span> <span class="n">D_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">node_list_foreign_keys</span>
        <span class="p">)</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">max_i</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Adding breadth - i: </span><span class="si">{}</span><span class="s2">, Max i: </span><span class="si">{}</span><span class="s2">] - </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> not found in node list.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">max_i</span><span class="p">,</span> <span class="n">O_id</span><span class="p">,</span> <span class="n">D_id</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">candidate_links_df</span><span class="p">,</span> <span class="n">node_list_foreign_keys</span> <span class="o">=</span> <span class="n">_add_breadth</span><span class="p">(</span>
                <span class="n">candidate_links_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># -----------------------------------</span>
        <span class="c1">#  Once have A and B in graph,</span>
        <span class="c1">#  Try calculating shortest path</span>
        <span class="c1"># -----------------------------------</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;calculating shortest path from graph&quot;</span><span class="p">)</span>
        <span class="p">(</span>
            <span class="n">sp_found</span><span class="p">,</span>
            <span class="n">graph</span><span class="p">,</span>
            <span class="n">candidate_links_df</span><span class="p">,</span>
            <span class="n">shortest_path_route</span><span class="p">,</span>
            <span class="n">shortest_path_links</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">candidate_links_df</span><span class="p">,</span> <span class="n">O_id</span><span class="p">,</span> <span class="n">D_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sp_found</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">graph</span><span class="p">,</span> <span class="n">candidate_links_df</span><span class="p">,</span> <span class="n">shortest_path_route</span><span class="p">,</span> <span class="n">shortest_path_links</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sp_found</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;No shortest path found with breadth of </span><span class="si">{}</span><span class="s2">, trying greater breadth until SP found or max breadth </span><span class="si">{}</span><span class="s2"> reached.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">max_i</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">sp_found</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">max_search_breadth</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Adding breadth, with shortest path iteration. i: </span><span class="si">{}</span><span class="s2"> Max i: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">i</span><span class="p">,</span> <span class="n">max_i</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">candidate_links_df</span><span class="p">,</span> <span class="n">node_list_foreign_keys</span> <span class="o">=</span> <span class="n">_add_breadth</span><span class="p">(</span>
                <span class="n">candidate_links_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span>
            <span class="p">)</span>
            <span class="p">(</span>
                <span class="n">sp_found</span><span class="p">,</span>
                <span class="n">graph</span><span class="p">,</span>
                <span class="n">candidate_links_df</span><span class="p">,</span>
                <span class="n">route</span><span class="p">,</span>
                <span class="n">shortest_path_links</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="n">candidate_links_df</span><span class="p">,</span> <span class="n">O_id</span><span class="p">,</span> <span class="n">D_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sp_found</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">graph</span><span class="p">,</span> <span class="n">candidate_links_df</span><span class="p">,</span> <span class="n">route</span><span class="p">,</span> <span class="n">shortest_path_links</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sp_found</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Couldn&#39;t find path from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> after adding </span><span class="si">{}</span><span class="s2"> links in breadth&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">O_id</span><span class="p">,</span> <span class="n">D_id</span><span class="p">,</span> <span class="n">i</span>
            <span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">NoPathFound</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="RoadwayNetwork.select_roadway_features"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.select_roadway_features">[docs]</a>    <span class="k">def</span> <span class="nf">select_roadway_features</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selection</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">search_mode</span><span class="o">=</span><span class="s2">&quot;drive&quot;</span><span class="p">,</span>
        <span class="n">force_search</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">sp_weight_factor</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GeoDataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Selects roadway features that satisfy selection criteria</span>

<span class="sd">        Example usage:</span>
<span class="sd">            net.select_roadway_features(</span>
<span class="sd">              selection = [ {</span>
<span class="sd">                #   a match condition for the from node using osm,</span>
<span class="sd">                #   shared streets, or model node number</span>
<span class="sd">                &#39;from&#39;: {&#39;osm_model_link_id&#39;: &#39;1234&#39;},</span>
<span class="sd">                #   a match for the to-node..</span>
<span class="sd">                &#39;to&#39;: {&#39;shstid&#39;: &#39;4321&#39;},</span>
<span class="sd">                #   a regex or match for facility condition</span>
<span class="sd">                #   could be # of lanes, facility type, etc.</span>
<span class="sd">                &#39;facility&#39;: {&#39;name&#39;:&#39;Main St&#39;},</span>
<span class="sd">                }, ... ])</span>

<span class="sd">        Args:</span>
<span class="sd">            selection : dictionary with keys for:</span>
<span class="sd">                 A - from node</span>
<span class="sd">                 B - to node</span>
<span class="sd">                 link - which includes at least a variable for `name`</span>
<span class="sd">            search_mode: mode which you are searching for; defaults to &quot;drive&quot;</span>
<span class="sd">            force_search: boolean directing method to perform search even if one</span>
<span class="sd">                with same selection dict is stored from a previous search.</span>
<span class="sd">            sp_weight_factor: multiple used to discourage shortest paths which</span>
<span class="sd">                meander from original search returned from name or ref query.</span>
<span class="sd">                If not set here, will default to value of sp_weight_factor in</span>
<span class="sd">                RoadwayNetwork instance. If not set there, will defaul to SP_WEIGHT_FACTOR.</span>

<span class="sd">        Returns: a list of link IDs in selection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;validating selection&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_selection</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sp_weight_factor</span><span class="p">:</span>
            <span class="n">sp_weight_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sp_weight_factor&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sp_weight_factor</span><span class="p">:</span>
            <span class="n">sp_weight_factor</span> <span class="o">=</span> <span class="n">SP_WEIGHT_FACTOR</span>

        <span class="c1"># create a unique key for the selection so that we can cache it</span>
        <span class="n">sel_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_selection_key</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Selection Key: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sel_key</span><span class="p">))</span>

        <span class="c1"># if this selection has been queried before, just return the</span>
        <span class="c1"># previously selected links</span>
        <span class="k">if</span> <span class="n">sel_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selections</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">force_search</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;selection_found&quot;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;selected_links&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Selection previously queried but no selection found&quot;</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;selection_found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">unique_link_identifer_in_selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selection_has_unique_link_id</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">unique_link_identifer_in_selection</span><span class="p">:</span>
            <span class="n">A_id</span><span class="p">,</span> <span class="n">B_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orig_dest_nodes_foreign_key</span><span class="p">(</span><span class="n">selection</span><span class="p">)</span>
        <span class="c1"># identify candidate links which match the initial query</span>
        <span class="c1"># assign them as iteration = 0</span>
        <span class="c1"># subsequent iterations that didn&#39;t match the query will be</span>
        <span class="c1"># assigned a heigher weight in the shortest path</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Building selection query&quot;</span><span class="p">)</span>
        <span class="c1"># build a selection query based on the selection dictionary</span>

        <span class="n">sel_query</span> <span class="o">=</span> <span class="n">ProjectCard</span><span class="o">.</span><span class="n">build_link_selection_query</span><span class="p">(</span>
            <span class="n">selection</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span>
            <span class="n">unique_link_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_link_ids</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modes_to_network_link_variables</span><span class="p">[</span><span class="n">search_mode</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Selecting features:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sel_query</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;candidate_links&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">sel_query</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span>
        <span class="p">)</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Completed query&quot;</span><span class="p">)</span>
        <span class="n">candidate_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span>
            <span class="s2">&quot;candidate_links&quot;</span>
        <span class="p">]</span>  <span class="c1"># b/c too long to keep that way</span>

        <span class="n">candidate_links</span><span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_links</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">unique_link_identifer_in_selection</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No links found based on unique link identifiers.</span><span class="se">\n</span><span class="s2">Selection Failed.&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_links</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;No candidate links in initial search.</span><span class="se">\n</span><span class="s2">Retrying query using &#39;ref&#39; instead of &#39;name&#39;&quot;</span>
            <span class="p">)</span>
            <span class="c1"># if the query doesn&#39;t come back with something from &#39;name&#39;</span>
            <span class="c1"># try it again with &#39;ref&#39; instead</span>
            <span class="n">selection_has_name_key</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="s2">&quot;name&quot;</span> <span class="ow">in</span> <span class="n">d</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">selection</span><span class="p">[</span><span class="s2">&quot;link&quot;</span><span class="p">])</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">selection_has_name_key</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Not able to complete search using &#39;ref&#39; instead of &#39;name&#39; because &#39;name&#39; not in search.&quot;</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;ref&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Not able to complete search using &#39;ref&#39; because &#39;ref&#39; not in network.&quot;</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Trying selection query replacing &#39;name&#39; with &#39;ref&#39;&quot;</span><span class="p">)</span>
            <span class="n">sel_query</span> <span class="o">=</span> <span class="n">sel_query</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;ref&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;candidate_links&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">sel_query</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span>
            <span class="p">)</span>
            <span class="n">candidate_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;candidate_links&quot;</span><span class="p">]</span>

            <span class="n">candidate_links</span><span class="p">[</span><span class="s2">&quot;i&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidate_links</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No candidate links in search using either &#39;name&#39; or &#39;ref&#39; in query.</span><span class="se">\n</span><span class="s2">Selection Failed.&quot;</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">unique_link_identifer_in_selection</span><span class="p">:</span>
            <span class="c1"># unique identifier exists and no need to go through big search</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;selected_links&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span>
                <span class="s2">&quot;candidate_links&quot;</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;selection_found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;selected_links&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Not a unique ID selection, conduct search.&quot;</span><span class="p">)</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;graph&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;candidate_links&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;route&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;links&quot;</span><span class="p">],</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_search</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;candidate_links&quot;</span><span class="p">],</span>
                <span class="n">A_id</span><span class="p">,</span>
                <span class="n">B_id</span><span class="p">,</span>
                <span class="n">weight_factor</span><span class="o">=</span><span class="n">sp_weight_factor</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">selection</span><span class="p">[</span><span class="s2">&quot;link&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;selected_links&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span>
                    <span class="s2">&quot;links&quot;</span>
                <span class="p">]</span>

            <span class="c1"># Conduct a &quot;selection on the selection&quot; if have additional requirements to satisfy</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resel_query</span> <span class="o">=</span> <span class="n">ProjectCard</span><span class="o">.</span><span class="n">build_link_selection_query</span><span class="p">(</span>
                    <span class="n">selection</span><span class="o">=</span><span class="n">selection</span><span class="p">,</span>
                    <span class="n">unique_link_ids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_link_ids</span><span class="p">,</span>
                    <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">modes_to_network_link_variables</span><span class="p">[</span><span class="n">search_mode</span><span class="p">],</span>
                    <span class="n">ignore</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Reselecting features:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resel_query</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;selected_links&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span>
                    <span class="s2">&quot;links&quot;</span>
                <span class="p">]</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">resel_query</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;selection_found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">selections</span><span class="p">[</span><span class="n">sel_key</span><span class="p">][</span><span class="s2">&quot;selected_links&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span></div>

<div class="viewcode-block" id="RoadwayNetwork.validate_properties"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.validate_properties">[docs]</a>    <span class="k">def</span> <span class="nf">validate_properties</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">properties</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">ignore_existing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">require_existing_for_change</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If there are change or existing commands, make sure that that</span>
<span class="sd">        property exists in the network.</span>

<span class="sd">        Args:</span>
<span class="sd">            properties : properties dictionary to be evaluated</span>
<span class="sd">            ignore_existing: If True, will only warn about properties</span>
<span class="sd">                that specify an &quot;existing&quot; value.  If False, will fail.</span>
<span class="sd">            require_existing_for_change: If True, will fail if there isn&#39;t</span>
<span class="sd">                a specified value in theproject card for existing when a</span>
<span class="sd">                change is specified.</span>

<span class="sd">        Returns: boolean value as to whether the properties dictonary is valid.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">validation_error_message</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">):</span>
                    <span class="n">validation_error_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s1">&#39;&quot;Change&quot; is specified for attribute </span><span class="si">{}</span><span class="s1">, but doesn</span><span class="se">\&#39;</span><span class="s1">t exist in base network</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;existing&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">ignore_existing</span><span class="p">:</span>
                    <span class="n">validation_error_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s1">&#39;&quot;Existing&quot; is specified for attribute </span><span class="si">{}</span><span class="s1">, but doesn</span><span class="se">\&#39;</span><span class="s1">t exist in base network</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;existing&quot;</span><span class="p">):</span>
                    <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s1">&#39;&quot;Existing&quot; is specified for attribute </span><span class="si">{}</span><span class="s1">, but doesn</span><span class="se">\&#39;</span><span class="s1">t exist in base network</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;change&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;existing&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">require_existing_for_change</span><span class="p">:</span>
                    <span class="n">validation_error_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="s1">&#39;&quot;Change&quot; is specified for attribute </span><span class="si">{}</span><span class="s1">, but there isn</span><span class="se">\&#39;</span><span class="s1">t a value for existing.</span><span class="se">\n</span><span class="s1">To proceed, run with the setting require_existing_for_change=False&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s1">&#39;&quot;Change&quot; is specified for attribute </span><span class="si">{}</span><span class="s1">, but there isn</span><span class="se">\&#39;</span><span class="s1">t a value for existing.</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">p</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="n">validation_error_message</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">validation_error_message</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span></div>

<div class="viewcode-block" id="RoadwayNetwork.apply"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_card_dictionary</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wrapper method to apply a project to a roadway network.</span>

<span class="sd">        Args:</span>
<span class="sd">            project_card_dictionary: dict</span>
<span class="sd">              a dictionary of the project card object</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Applying Project to Roadway Network: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">project_card_dictionary</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">_apply_individual_change</span><span class="p">(</span><span class="n">project_dictionary</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">project_dictionary</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;roadway property change&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">apply_roadway_feature_change</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">select_roadway_features</span><span class="p">(</span><span class="n">project_dictionary</span><span class="p">[</span><span class="s2">&quot;facility&quot;</span><span class="p">]),</span>
                    <span class="n">project_dictionary</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">project_dictionary</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;parallel managed lanes&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">apply_managed_lane_feature_change</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">select_roadway_features</span><span class="p">(</span><span class="n">project_dictionary</span><span class="p">[</span><span class="s2">&quot;facility&quot;</span><span class="p">]),</span>
                    <span class="n">project_dictionary</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">project_dictionary</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;add new roadway&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_new_roadway_feature_change</span><span class="p">(</span>
                    <span class="n">project_dictionary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;links&quot;</span><span class="p">),</span> <span class="n">project_dictionary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nodes&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">project_dictionary</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;roadway deletion&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete_roadway_feature_change</span><span class="p">(</span>
                    <span class="n">project_dictionary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;links&quot;</span><span class="p">),</span> <span class="n">project_dictionary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nodes&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">project_dictionary</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;calculated roadway&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">apply_python_calculation</span><span class="p">(</span><span class="n">project_dictionary</span><span class="p">[</span><span class="s2">&quot;pycode&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="p">(</span><span class="ne">BaseException</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">project_card_dictionary</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;changes&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">project_dictionary</span> <span class="ow">in</span> <span class="n">project_card_dictionary</span><span class="p">[</span><span class="s2">&quot;changes&quot;</span><span class="p">]:</span>
                <span class="n">_apply_individual_change</span><span class="p">(</span><span class="n">project_dictionary</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_apply_individual_change</span><span class="p">(</span><span class="n">project_card_dictionary</span><span class="p">)</span></div>

<div class="viewcode-block" id="RoadwayNetwork.apply_python_calculation"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.apply_python_calculation">[docs]</a>    <span class="k">def</span> <span class="nf">apply_python_calculation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">pycode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">RoadwayNetwork</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Changes roadway network object by executing pycode.</span>

<span class="sd">        Args:</span>
<span class="sd">            pycode: python code which changes values in the roadway network object</span>
<span class="sd">            in_place: update self or return a new roadway network object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">pycode</span><span class="p">)</span></div>

<div class="viewcode-block" id="RoadwayNetwork.apply_roadway_feature_change"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.apply_roadway_feature_change">[docs]</a>    <span class="k">def</span> <span class="nf">apply_roadway_feature_change</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">link_idx</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">properties</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">RoadwayNetwork</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Changes the roadway attributes for the selected features based on the</span>
<span class="sd">        project card information passed</span>

<span class="sd">        Args:</span>
<span class="sd">            link_idx : list</span>
<span class="sd">                lndices of all links to apply change to</span>
<span class="sd">            properties : list of dictionarys</span>
<span class="sd">                roadway properties to change</span>
<span class="sd">            in_place: boolean</span>
<span class="sd">                update self or return a new roadway network object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check if there are change or existing commands that that property</span>
        <span class="c1">#   exists in the network</span>
        <span class="c1"># if there is a set command, add that property to network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validate_properties</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">properties</span><span class="p">):</span>
            <span class="n">attribute</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span>

            <span class="c1"># if project card specifies an existing value in the network</span>
            <span class="c1">#   check and see if the existing value in the network matches</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;existing&quot;</span><span class="p">):</span>
                <span class="n">network_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">link_idx</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">network_values</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;existing&quot;</span><span class="p">)]):</span>
                    <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;Existing value defined for </span><span class="si">{}</span><span class="s2"> in project card does &quot;</span>
                        <span class="s2">&quot;not match the value in the roadway network for the &quot;</span>
                        <span class="s2">&quot;selected links&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">attribute</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">in_place</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;set&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">link_idx</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">link_idx</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">link_idx</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;change&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">updated_network</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;set&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">updated_network</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">link_idx</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">updated_network</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">link_idx</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">updated_network</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">link_idx</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;change&quot;</span><span class="p">]</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">updated_network</span></div>

<div class="viewcode-block" id="RoadwayNetwork.apply_managed_lane_feature_change"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.apply_managed_lane_feature_change">[docs]</a>    <span class="k">def</span> <span class="nf">apply_managed_lane_feature_change</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">link_idx</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">properties</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">RoadwayNetwork</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the managed lane feature changes to the roadway network</span>

<span class="sd">        Args:</span>
<span class="sd">            link_idx : list of lndices of all links to apply change to</span>
<span class="sd">            properties : list of dictionarys roadway properties to change</span>
<span class="sd">            in_place: boolean to indicate whether to update self or return</span>
<span class="sd">                a new roadway network object</span>

<span class="sd">        .. todo:: decide on connectors info when they are more specific in project card</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># add ML flag</span>
        <span class="k">if</span> <span class="s2">&quot;managed&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">link_idx</span><span class="p">,</span> <span class="s2">&quot;managed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;managed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">link_idx</span><span class="p">,</span> <span class="s2">&quot;managed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">properties</span><span class="p">:</span>
            <span class="n">attribute</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;property&quot;</span><span class="p">]</span>
            <span class="n">attr_value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">link_idx</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;group&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">attr_value</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="k">if</span> <span class="s2">&quot;set&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">attr_value</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="s2">&quot;change&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">attr_value</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;change&quot;</span><span class="p">]</span>
                        <span class="p">)</span>

                    <span class="n">attr_value</span><span class="p">[</span><span class="s2">&quot;timeofday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;group&quot;</span><span class="p">]:</span>
                        <span class="n">category</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">tod</span> <span class="ow">in</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;timeofday&quot;</span><span class="p">]:</span>
                            <span class="k">if</span> <span class="s2">&quot;set&quot;</span> <span class="ow">in</span> <span class="n">tod</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="n">attr_value</span><span class="p">[</span><span class="s2">&quot;timeofday&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">{</span>
                                        <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span>
                                        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">parse_time_spans</span><span class="p">(</span><span class="n">tod</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]),</span>
                                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">tod</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">],</span>
                                    <span class="p">}</span>
                                <span class="p">)</span>
                            <span class="k">elif</span> <span class="s2">&quot;change&quot;</span> <span class="ow">in</span> <span class="n">tod</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                                <span class="n">attr_value</span><span class="p">[</span><span class="s2">&quot;timeofday&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="p">{</span>
                                        <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span>
                                        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">parse_time_spans</span><span class="p">(</span><span class="n">tod</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]),</span>
                                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span>
                                        <span class="o">+</span> <span class="n">tod</span><span class="p">[</span><span class="s2">&quot;change&quot;</span><span class="p">],</span>
                                    <span class="p">}</span>
                                <span class="p">)</span>

                <span class="k">elif</span> <span class="s2">&quot;timeofday&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">attr_value</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="k">if</span> <span class="s2">&quot;set&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">attr_value</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="s2">&quot;change&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">attr_value</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;change&quot;</span><span class="p">]</span>
                        <span class="p">)</span>

                    <span class="n">attr_value</span><span class="p">[</span><span class="s2">&quot;timeofday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">tod</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;timeofday&quot;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="s2">&quot;set&quot;</span> <span class="ow">in</span> <span class="n">tod</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">attr_value</span><span class="p">[</span><span class="s2">&quot;timeofday&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">parse_time_spans</span><span class="p">(</span><span class="n">tod</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]),</span>
                                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">tod</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">],</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
                        <span class="k">elif</span> <span class="s2">&quot;change&quot;</span> <span class="ow">in</span> <span class="n">tod</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                            <span class="n">attr_value</span><span class="p">[</span><span class="s2">&quot;timeofday&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                <span class="p">{</span>
                                    <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">parse_time_spans</span><span class="p">(</span><span class="n">tod</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]),</span>
                                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span>
                                    <span class="o">+</span> <span class="n">tod</span><span class="p">[</span><span class="s2">&quot;change&quot;</span><span class="p">],</span>
                                <span class="p">}</span>
                            <span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;set&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">attr_value</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;set&quot;</span><span class="p">]</span>

                <span class="k">elif</span> <span class="s2">&quot;change&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">attr_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;change&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">in_place</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                        <span class="n">attr_value</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span>
                    <span class="p">):</span>
                        <span class="c1"># if the attribute already exists</span>
                        <span class="c1"># and the attr value we are trying to set is not numeric</span>
                        <span class="c1"># then change the attribute type to object</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                            <span class="nb">object</span>
                        <span class="p">)</span>

                    <span class="k">if</span> <span class="n">attribute</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="c1"># if it is a new attribute then initialize with NaN values</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NaN&quot;</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr_value</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">updated_network</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
                        <span class="n">attr_value</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span>
                    <span class="p">):</span>
                        <span class="c1"># if the attribute already exists</span>
                        <span class="c1"># and the attr value we are trying to set is not numeric</span>
                        <span class="c1"># then change the attribute type to object</span>
                        <span class="n">updated_network</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="n">updated_network</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span>
                            <span class="n">attribute</span>
                        <span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">attribute</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">updated_network</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="c1"># if it is a new attribute then initialize with NaN values</span>
                        <span class="n">updated_network</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;NaN&quot;</span>

                    <span class="n">updated_network</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">attribute</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr_value</span>

                    <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">properties</span><span class="p">):</span>
                        <span class="k">return</span> <span class="n">updated_network</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="RoadwayNetwork.add_new_roadway_feature_change"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.add_new_roadway_feature_change">[docs]</a>    <span class="k">def</span> <span class="nf">add_new_roadway_feature_change</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">links</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        add the new roadway features defined in the project card.</span>
<span class="sd">        new shapes are also added for the new roadway links.</span>

<span class="sd">        args:</span>
<span class="sd">            links : list of dictionaries</span>
<span class="sd">            nodes : list of dictionaries</span>

<span class="sd">        returns: None</span>

<span class="sd">        .. todo:: validate links and nodes dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">_add_dict_to_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">new_dict</span><span class="p">):</span>
            <span class="n">df_column_names</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
            <span class="n">new_row_to_add</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="c1"># add the fields from project card that are in the network</span>
            <span class="k">for</span> <span class="nb">property</span> <span class="ow">in</span> <span class="n">df_column_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">property</span> <span class="ow">in</span> <span class="n">new_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">df</span><span class="p">[</span><span class="nb">property</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">new_dict</span><span class="p">[</span><span class="nb">property</span><span class="p">],</span> <span class="n">downcast</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="nb">property</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="nb">property</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_numeric</span><span class="p">(</span><span class="n">new_dict</span><span class="p">[</span><span class="nb">property</span><span class="p">],</span> <span class="n">downcast</span><span class="o">=</span><span class="s2">&quot;integer&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_dict</span><span class="p">[</span><span class="nb">property</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="n">new_row_to_add</span><span class="p">[</span><span class="nb">property</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

            <span class="c1"># add the fields from project card that are NOT in the network</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">new_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df_column_names</span><span class="p">:</span>
                    <span class="n">new_row_to_add</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="n">out_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_row_to_add</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out_df</span>

        <span class="k">if</span> <span class="n">nodes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;New link to add doesn&#39;t contain link foreign key identifier: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span>
                    <span class="p">)</span>
                    <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="n">node_query</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span> <span class="o">+</span> <span class="s2">&quot; == &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">node_query</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Node with id = </span><span class="si">{}</span><span class="s2"> already exist in the network&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">node</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="n">node</span><span class="p">[</span><span class="s2">&quot;new_node&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span> <span class="o">=</span> <span class="n">_add_dict_to_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

            <span class="c1"># add geometry for new nodes</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;new_node&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;new_node&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">links</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_foreign_key</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;New link to add doesn&#39;t contain link foreign key identifier: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">key</span>
                        <span class="p">)</span>
                        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="n">ab_query</span> <span class="o">=</span> <span class="s2">&quot;A == &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot; and B == &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">link</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">])</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">ab_query</span><span class="p">,</span> <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;python&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Link with A = </span><span class="si">{}</span><span class="s2"> and B = </span><span class="si">{}</span><span class="s2"> already exist in the network&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">link</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">],</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>
                <span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;New link to add has A node = </span><span class="si">{}</span><span class="s2"> but the node does not exist in the network&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">link</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">link</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span>
                <span class="p">]</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;New link to add has B node = </span><span class="si">{}</span><span class="s2"> but the node does not exist in the network&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">link</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
                <span class="n">link</span><span class="p">[</span><span class="s2">&quot;new_link&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span> <span class="o">=</span> <span class="n">_add_dict_to_df</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>

            <span class="c1"># add location reference and geometry for new links</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">create_location_reference_from_nodes</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;new_link&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">create_line_string</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;new_link&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">create_unique_shape_id</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;new_link&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
                <span class="k">else</span> <span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span><span class="p">],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="c1"># add new shapes</span>
            <span class="n">added_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;new_link&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span>

            <span class="n">added_shapes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">added_links</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]})</span>
            <span class="n">added_shapes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">added_shapes_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">create_unique_shape_id</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shapes_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapes_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">added_shapes_df</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;new_link&quot;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="RoadwayNetwork.delete_roadway_feature_change"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.delete_roadway_feature_change">[docs]</a>    <span class="k">def</span> <span class="nf">delete_roadway_feature_change</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">links</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">ignore_missing</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        delete the roadway features defined in the project card.</span>
<span class="sd">        valid links and nodes defined in the project gets deleted</span>
<span class="sd">        and shapes corresponding to the deleted links are also deleted.</span>

<span class="sd">        Args:</span>
<span class="sd">            links : dict</span>
<span class="sd">                list of dictionaries</span>
<span class="sd">            nodes : dict</span>
<span class="sd">                list of dictionaries</span>
<span class="sd">            ignore_missing: bool</span>
<span class="sd">                If True, will only warn about links/nodes that are missing from</span>
<span class="sd">                network but specified to &quot;delete&quot; in project card</span>
<span class="sd">                If False, will fail.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">missing_error_message</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">links</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">shapes_to_delete</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">links</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">missing_links</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
                <span class="k">if</span> <span class="n">missing_links</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Links attribute </span><span class="si">{}</span><span class="s2"> with values as </span><span class="si">{}</span><span class="s2"> does not exist in the network</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">key</span><span class="p">,</span> <span class="n">missing_links</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">ignore_missing</span><span class="p">:</span>
                        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">missing_error_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

                <span class="n">deleted_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">val</span><span class="p">)]</span>
                <span class="n">shapes_to_delete</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">deleted_links</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">val</span><span class="p">)],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">shapes_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shapes_df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">shapes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">shapes_to_delete</span><span class="p">)</span>
                <span class="p">],</span>
                <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">nodes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">missing_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
                <span class="k">if</span> <span class="n">missing_nodes</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Nodes attribute </span><span class="si">{}</span><span class="s2"> with values as </span><span class="si">{}</span><span class="s2"> does not exist in the network</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">key</span><span class="p">,</span> <span class="n">missing_links</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">ignore_missing</span><span class="p">:</span>
                        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">missing_error_message</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="o">~</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">val</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">missing_error_message</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_error_message</span><span class="p">))</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">()</span></div>

<div class="viewcode-block" id="RoadwayNetwork.get_property_by_time_period_and_group"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.get_property_by_time_period_and_group">[docs]</a>    <span class="k">def</span> <span class="nf">get_property_by_time_period_and_group</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">time_period</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">default_return</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a series for the properties with a specific group or time period.</span>

<span class="sd">        args</span>
<span class="sd">        ------</span>
<span class="sd">        prop: str</span>
<span class="sd">          the variable that you want from network</span>
<span class="sd">        time_period: list(str)</span>
<span class="sd">          the time period that you are querying for</span>
<span class="sd">          i.e. [&#39;16:00&#39;, &#39;19:00&#39;]</span>
<span class="sd">        category: str or list(str)(Optional)</span>
<span class="sd">          the group category</span>
<span class="sd">          i.e. &quot;sov&quot;</span>

<span class="sd">          or</span>

<span class="sd">          list of group categories in order of search, i.e.</span>
<span class="sd">          [&quot;hov3&quot;,&quot;hov2&quot;]</span>
<span class="sd">        default_return: what to return if variable or time period not found. Default is None.</span>

<span class="sd">        returns</span>
<span class="sd">        --------</span>
<span class="sd">        pandas series</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Property </span><span class="si">{}</span><span class="s2"> not in links to split, returning as default value: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">default_value</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">default_return</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link_df</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_get_property</span><span class="p">(</span>
            <span class="n">v</span><span class="p">,</span>
            <span class="n">time_spans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">category</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">return_partial_match</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
            <span class="n">partial_match_minutes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
        <span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">            .. todo:: return the time period with the largest overlap</span>

<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="n">category</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">time_spans</span><span class="p">:</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Shouldn&#39;t have a category group without time spans&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Shouldn&#39;t have a category group without time spans&quot;</span><span class="p">)</span>

            <span class="c1"># simple case</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">v</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">category</span><span class="p">:</span>
                <span class="n">category</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">category</span> <span class="o">=</span> <span class="p">[</span><span class="n">category</span><span class="p">]</span>
            <span class="n">search_cats</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">category</span><span class="p">]</span>

            <span class="c1"># if no time or group specified, but it is a complex link situation</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">time_spans</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;default&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;variable: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Variable </span><span class="si">{}</span><span class="s2"> is more complex in network than query&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeofday&quot;</span><span class="p">):</span>
                <span class="n">categories</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">tg</span> <span class="ow">in</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;timeofday&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">time_spans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">time_spans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">time_spans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">time_spans</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="n">tg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">):</span>
                            <span class="n">categories</span> <span class="o">+=</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">search_cats</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CAT:&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]:</span>
                                    <span class="c1"># print(&quot;Var:&quot;, v)</span>
                                    <span class="c1"># print(</span>
                                    <span class="c1">#    &quot;RETURNING:&quot;, time_spans, category, tg[&quot;value&quot;]</span>
                                    <span class="c1"># )</span>
                                    <span class="k">return</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># print(&quot;Var:&quot;, v)</span>
                            <span class="c1"># print(&quot;RETURNING:&quot;, time_spans, category, tg[&quot;value&quot;])</span>
                            <span class="k">return</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>

                    <span class="k">if</span> <span class="p">((</span><span class="n">time_spans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">time_spans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">time_spans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">time_spans</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span>
                        <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">):</span>
                        <span class="k">if</span> <span class="n">tg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">):</span>
                            <span class="n">categories</span> <span class="o">+=</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">search_cats</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CAT:&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]:</span>
                                    <span class="c1"># print(&quot;Var:&quot;, v)</span>
                                    <span class="c1"># print(</span>
                                    <span class="c1">#    &quot;RETURNING:&quot;, time_spans, category, tg[&quot;value&quot;]</span>
                                    <span class="c1"># )</span>
                                    <span class="k">return</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># print(&quot;Var:&quot;, v)</span>
                            <span class="c1"># print(&quot;RETURNING:&quot;, time_spans, category, tg[&quot;value&quot;])</span>
                            <span class="k">return</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>

                    <span class="c1"># if there isn&#39;t a fully matched time period, see if there is an overlapping one</span>
                    <span class="c1"># right now just return the first overlapping ones</span>
                    <span class="c1"># TODO return the time period with the largest overlap</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">time_spans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="n">time_spans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">time_spans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                        <span class="ow">and</span> <span class="p">(</span><span class="n">time_spans</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">):</span>
                        <span class="n">overlap_minutes</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                            <span class="mi">0</span><span class="p">,</span>
                            <span class="nb">min</span><span class="p">(</span><span class="n">tg</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">time_spans</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">time_spans</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="p">)</span>
                        <span class="c1"># print(&quot;OLM&quot;,overlap_minutes)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_partial_match</span> <span class="ow">and</span> <span class="n">overlap_minutes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="s2">&quot;Couldn&#39;t find time period consistent with </span><span class="si">{}</span><span class="s2">, but found a partial match: </span><span class="si">{}</span><span class="s2">. Consider allowing partial matches using &#39;return_partial_match&#39; keyword or updating query.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">time_spans</span><span class="p">,</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">elif</span> <span class="p">(</span>
                            <span class="n">overlap_minutes</span> <span class="o">&lt;</span> <span class="n">partial_match_minutes</span>
                            <span class="ow">and</span> <span class="n">overlap_minutes</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="p">):</span>
                            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="s2">&quot;Time period: </span><span class="si">{}</span><span class="s2"> overlapped less than the minimum number of minutes (</span><span class="si">{}</span><span class="s2">&lt;</span><span class="si">{}</span><span class="s2">) to be considered a match with time period in network: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">time_spans</span><span class="p">,</span>
                                    <span class="n">overlap_minutes</span><span class="p">,</span>
                                    <span class="n">partial_match_minutes</span><span class="p">,</span>
                                    <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">elif</span> <span class="n">overlap_minutes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                                <span class="s2">&quot;Returning a partial time period match. Time period: </span><span class="si">{}</span><span class="s2"> overlapped the minimum number of minutes (</span><span class="si">{}</span><span class="s2">&gt;=</span><span class="si">{}</span><span class="s2">) to be considered a match with time period in network: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">time_spans</span><span class="p">,</span>
                                    <span class="n">overlap_minutes</span><span class="p">,</span>
                                    <span class="n">partial_match_minutes</span><span class="p">,</span>
                                    <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                            <span class="k">if</span> <span class="n">tg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">):</span>
                                <span class="n">categories</span> <span class="o">+=</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]</span>
                                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">search_cats</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CAT:&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">])</span>
                                    <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;category&quot;</span><span class="p">]:</span>
                                        <span class="c1"># print(&quot;Var:&quot;, v)</span>
                                        <span class="c1"># print(</span>
                                        <span class="c1">#    &quot;RETURNING:&quot;,</span>
                                        <span class="c1">#    time_spans,</span>
                                        <span class="c1">#    category,</span>
                                        <span class="c1">#    tg[&quot;value&quot;],</span>
                                        <span class="c1"># )</span>
                                        <span class="k">return</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># print(&quot;Var:&quot;, v)</span>
                                <span class="c1"># print(&quot;RETURNING:&quot;, time_spans, category, tg[&quot;value&quot;])</span>
                                <span class="k">return</span> <span class="n">tg</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>

<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                WranglerLogger.debug(</span>
<span class="sd">                    &quot;\nCouldn&#39;t find time period for {}, returning default&quot;.format(</span>
<span class="sd">                        str(time_spans)</span>
<span class="sd">                    )</span>
<span class="sd">                )</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="s2">&quot;default&quot;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="c1"># print(&quot;Var:&quot;, v)</span>
                    <span class="c1"># print(&quot;RETURNING:&quot;, time_spans, v[&quot;default&quot;])</span>
                    <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># print(&quot;Var:&quot;, v)</span>
                    <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Can&#39;t find default; must specify a category in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Can&#39;t find default, must specify a category in: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

        <span class="n">time_spans</span> <span class="o">=</span> <span class="n">parse_time_spans</span><span class="p">(</span><span class="n">time_period</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="n">_get_property</span><span class="p">,</span> <span class="n">time_spans</span><span class="o">=</span><span class="n">time_spans</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="n">category</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="RoadwayNetwork.update_distance"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.update_distance">[docs]</a>    <span class="k">def</span> <span class="nf">update_distance</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">links_df</span><span class="p">:</span> <span class="n">GeoDataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_shapes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">units</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;miles&quot;</span><span class="p">,</span>
        <span class="n">network_variable</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;distance&quot;</span><span class="p">,</span>
        <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate link distance in specified units to network variable using either straight line</span>
<span class="sd">        distance or (if specified) shape distance if available.</span>

<span class="sd">        Args:</span>
<span class="sd">            links_df: Links GeoDataFrame.  Useful if want to update a portion of network links</span>
<span class="sd">                (i.e. only centroid connectors). If not provided, will use entire self.links_df.</span>
<span class="sd">            use_shapes: if True, will add length information from self.shapes_df rather than crow-fly.</span>
<span class="sd">                If no corresponding shape found in self.shapes_df, will default to crow-fly.</span>
<span class="sd">            units: units to use. Defaults to the standard unit of miles. Available units: &quot;meters&quot;, &quot;miles&quot;.</span>
<span class="sd">            network_variable: variable to store link distance in. Defaults to &quot;distance&quot;.</span>
<span class="sd">            overwrite: Defaults to True and will overwrite all existing calculated distances.</span>
<span class="sd">                False will only update NaNs.</span>
<span class="sd">            inplace: updates self.links_df</span>

<span class="sd">        Returns:</span>
<span class="sd">            links_df with updated distance</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">units</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;miles&quot;</span><span class="p">,</span><span class="s2">&quot;meters&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="k">if</span> <span class="n">links_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">links_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Update distance in </span><span class="si">{}</span><span class="s2"> to variable: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">units</span><span class="p">,</span> <span class="n">network_variable</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  - overwriting existing calculated values if found.&quot;</span>
        <span class="k">if</span> <span class="n">use_shapes</span><span class="p">:</span> <span class="n">msg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">  - using shapes_df length if found.&quot;</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start actual process</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">temp_links_gdf</span> <span class="o">=</span> <span class="n">links_df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">temp_links_gdf</span><span class="o">.</span><span class="n">crs</span> <span class="o">=</span> <span class="s2">&quot;EPSG:4326&quot;</span>
        <span class="n">temp_links_gdf</span> <span class="o">=</span> <span class="n">temp_links_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">26915</span><span class="p">)</span> <span class="c1">#in meters</span>

        <span class="n">conversion_from_meters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;miles&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="o">/</span><span class="mf">1609.34</span><span class="p">,</span> <span class="s2">&quot;meters&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">temp_links_gdf</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_links_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">length</span> <span class="o">*</span> <span class="n">conversion_from_meters</span><span class="p">[</span><span class="n">units</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">use_shapes</span><span class="p">:</span>
            <span class="n">_needed_shapes_gdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapes_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">shapes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span><span class="p">]</span> <span class="ow">in</span> <span class="n">links_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span><span class="p">]</span>
            <span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">_needed_shapes_gdf</span> <span class="o">=</span> <span class="n">_needed_shapes_gdf</span><span class="o">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">26915</span><span class="p">)</span>
            <span class="n">_needed_shapes_gdf</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">_needed_shapes_gdf</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">length</span> <span class="o">*</span> <span class="n">conversion_from_meters</span><span class="p">[</span><span class="n">units</span><span class="p">]</span>

            <span class="n">temp_links_gdf</span> <span class="o">=</span> <span class="n">update_df</span><span class="p">(</span>
                <span class="n">temp_links_gdf</span><span class="p">,</span>
                <span class="n">_needed_shapes_gdf</span><span class="p">,</span>
                <span class="n">merge_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span><span class="p">,</span>
                <span class="n">update_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">network_variable</span><span class="p">],</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;update if found&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">links_df</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_links_gdf</span><span class="p">[</span><span class="n">network_variable</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">links_df</span> <span class="o">=</span> <span class="n">update_df</span><span class="p">(</span>
                <span class="n">links_df</span><span class="p">,</span>
                <span class="n">temp_links_gdf</span><span class="p">,</span>
                <span class="n">merge_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_link_key</span><span class="p">,</span>
                <span class="n">update_fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">network_variable</span><span class="p">],</span>
                <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;update nan&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span> <span class="o">=</span> <span class="n">links_df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">links_df</span></div>

<div class="viewcode-block" id="RoadwayNetwork.create_dummy_connector_links"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.create_dummy_connector_links">[docs]</a>    <span class="k">def</span> <span class="nf">create_dummy_connector_links</span><span class="p">(</span>
        <span class="n">gp_df</span><span class="p">:</span> <span class="n">GeoDataFrame</span><span class="p">,</span>
        <span class="n">ml_df</span><span class="p">:</span> <span class="n">GeoDataFrame</span><span class="p">,</span>
        <span class="n">access_lanes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">egress_lanes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">access_roadway</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ml_access&quot;</span><span class="p">,</span>
        <span class="n">egress_roadway</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ml_access&quot;</span><span class="p">,</span>
        <span class="n">access_name_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Access Dummy &quot;</span><span class="p">,</span>
        <span class="n">egress_name_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Egress Dummy &quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        create dummy connector links between the general purpose and managed lanes</span>

<span class="sd">        args:</span>
<span class="sd">            gp_df : GeoDataFrame</span>
<span class="sd">                dataframe of general purpose links (where managed lane also exists)</span>
<span class="sd">            ml_df : GeoDataFrame</span>
<span class="sd">                dataframe of corresponding managed lane links,</span>
<span class="sd">            access_lanes: int</span>
<span class="sd">                number of lanes in access dummy link</span>
<span class="sd">            egress_lanes: int</span>
<span class="sd">                number of lanes in egress dummy link</span>
<span class="sd">            access_roadway: str</span>
<span class="sd">                roaday type for access dummy link</span>
<span class="sd">            egress_roadway: str</span>
<span class="sd">                roadway type for egress dummy link</span>
<span class="sd">            access_name_prefix: str</span>
<span class="sd">                prefix for access dummy link name</span>
<span class="sd">            egress_name_prefix: str</span>
<span class="sd">                prefix for egress dummy link name</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">gp_ml_links_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">gp_df</span><span class="p">,</span> <span class="n">ml_df</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s2">&quot;ML_&quot;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span>
        <span class="p">)</span>

        <span class="n">access_df</span> <span class="o">=</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">egress_df</span> <span class="o">=</span> <span class="n">gp_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">_get_connector_references</span><span class="p">(</span><span class="n">ref_1</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">ref_2</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;access&quot;</span><span class="p">:</span>
                <span class="n">out_location_reference</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;sequence&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span> <span class="n">ref_1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;point&quot;</span><span class="p">]},</span>
                    <span class="p">{</span><span class="s2">&quot;sequence&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span> <span class="n">ref_2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;point&quot;</span><span class="p">]},</span>
                <span class="p">]</span>

            <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s2">&quot;egress&quot;</span><span class="p">:</span>
                <span class="n">out_location_reference</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="s2">&quot;sequence&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span> <span class="n">ref_2</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;point&quot;</span><span class="p">]},</span>
                    <span class="p">{</span><span class="s2">&quot;sequence&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;point&quot;</span><span class="p">:</span> <span class="n">ref_1</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;point&quot;</span><span class="p">]},</span>
                <span class="p">]</span>
            <span class="k">return</span> <span class="n">out_location_reference</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">gp_ml_links_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">access_set</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ML_access&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">access_set</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span> <span class="ow">or</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;A&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">access_set</span><span class="p">:</span>
                <span class="n">access_row</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">access_row</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>
                <span class="n">access_row</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ML_A&quot;</span><span class="p">]</span>
                <span class="n">access_row</span><span class="p">[</span><span class="s2">&quot;lanes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">access_row</span><span class="p">[</span><span class="s2">&quot;model_link_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;model_link_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ML_model_link_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">)</span>
                <span class="n">access_row</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ML_access&quot;</span><span class="p">]</span>
                <span class="n">access_row</span><span class="p">[</span><span class="s2">&quot;drive_access&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;drive_access&quot;</span><span class="p">]</span>
                <span class="n">access_row</span><span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_connector_references</span><span class="p">(</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ML_locationReferences&quot;</span><span class="p">],</span> <span class="s2">&quot;access&quot;</span>
                <span class="p">)</span>
                <span class="n">access_row</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">haversine_distance</span><span class="p">(</span>
                    <span class="n">access_row</span><span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;point&quot;</span><span class="p">],</span>
                    <span class="n">access_row</span><span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;point&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">access_row</span><span class="p">[</span><span class="s2">&quot;roadway&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ml_access&quot;</span>
                <span class="n">access_row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Access Dummy &quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

                <span class="c1"># ref is not a *required* attribute, so make conditional:</span>
                <span class="k">if</span> <span class="s2">&quot;ref&quot;</span> <span class="ow">in</span> <span class="n">gp_ml_links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">access_row</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">access_row</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="n">access_df</span> <span class="o">=</span> <span class="n">access_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">access_row</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">egress_set</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;ML_egress&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">egress_set</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span> <span class="ow">or</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;B&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">egress_set</span><span class="p">:</span>
                <span class="n">egress_row</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">egress_row</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ML_B&quot;</span><span class="p">]</span>
                <span class="n">egress_row</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span>
                <span class="n">egress_row</span><span class="p">[</span><span class="s2">&quot;lanes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">egress_row</span><span class="p">[</span><span class="s2">&quot;model_link_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;model_link_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ML_model_link_id&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span>
                <span class="p">)</span>
                <span class="n">egress_row</span><span class="p">[</span><span class="s2">&quot;access&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ML_access&quot;</span><span class="p">]</span>
                <span class="n">egress_row</span><span class="p">[</span><span class="s2">&quot;drive_access&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;drive_access&quot;</span><span class="p">]</span>
                <span class="n">egress_row</span><span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_connector_references</span><span class="p">(</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ML_locationReferences&quot;</span><span class="p">],</span> <span class="s2">&quot;egress&quot;</span>
                <span class="p">)</span>
                <span class="n">egress_row</span><span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">haversine_distance</span><span class="p">(</span>
                    <span class="n">egress_row</span><span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;point&quot;</span><span class="p">],</span>
                    <span class="n">egress_row</span><span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;point&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">egress_row</span><span class="p">[</span><span class="s2">&quot;roadway&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ml_egress&quot;</span>
                <span class="n">egress_row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Egress Dummy &quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

                <span class="c1"># ref is not a *required* attribute, so make conditional:</span>
                <span class="k">if</span> <span class="s2">&quot;ref&quot;</span> <span class="ow">in</span> <span class="n">gp_ml_links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="n">egress_row</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">egress_row</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

                <span class="n">egress_df</span> <span class="o">=</span> <span class="n">egress_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">egress_row</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">access_df</span><span class="p">,</span> <span class="n">egress_df</span><span class="p">)</span></div>

<div class="viewcode-block" id="RoadwayNetwork.create_managed_lane_network"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.create_managed_lane_network">[docs]</a>    <span class="k">def</span> <span class="nf">create_managed_lane_network</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">keep_same_attributes_ml_and_gp</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">keep_additional_attributes_ml_and_gp</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">managed_lanes_required_attributes</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">managed_lanes_node_id_scalar</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">managed_lanes_link_id_scalar</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">in_place</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RoadwayNetwork</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a roadway network with managed lanes links separated out.</span>
<span class="sd">        Add new parallel managed lane links, access/egress links,</span>
<span class="sd">        and add shapes corresponding to the new links</span>

<span class="sd">        args:</span>
<span class="sd">            keep_same_attributes_ml_and_gp: list of attributes to copy from general purpose</span>
<span class="sd">                lane to managed lane. If not specified, will look for value in the RoadwayNetwork</span>
<span class="sd">                instance.  If not found there, will default to KEEP_SAME_ATTRIBUTES_ML_AND_GP.</span>
<span class="sd">            keep_additional_attributes_ml_and_gp: list of additional attributes to add. This is useful</span>
<span class="sd">                if you want to leave the default attributes and then ALSO some others.</span>
<span class="sd">            managed_lanes_required_attributes: list of attributes that are required to be specified</span>
<span class="sd">                in new managed lanes. If not specified, will look for value in the RoadwayNetwork</span>
<span class="sd">                instance.  If not found there, will default to MANAGED_LANES_REQUIRED_ATTRIBUTES.</span>
<span class="sd">            managed_lanes_node_id_scalar: integer value added to original node IDs to create managed</span>
<span class="sd">                lane unique ids. If not specified, will look for value in the RoadwayNetwork</span>
<span class="sd">                instance.  If not found there, will default to MANAGED_LANES_NODE_ID_SCALAR.</span>
<span class="sd">            managed_lanes_link_id_scalar: integer value added to original link IDs to create managed</span>
<span class="sd">                lane unique ids. If not specified, will look for value in the RoadwayNetwork</span>
<span class="sd">                instance.  If not found there, will default to MANAGED_LANES_LINK_ID_SCALAR.</span>
<span class="sd">            in_place: update self or return a new roadway network object</span>

<span class="sd">        returns: A RoadwayNetwork instance</span>

<span class="sd">        .. todo:: make this a more rigorous test</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Creating network with duplicated managed lanes&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;ml_access&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;roadway&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;managed lane access links already exist in network; shouldn&#39;t be running create managed lane network. Returning network as-is.&quot;</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">in_place</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># identify parameters to use</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_same_attributes_ml_and_gp</span><span class="p">:</span>
            <span class="n">keep_same_attributes_ml_and_gp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keep_same_attributes_ml_and_gp&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_same_attributes_ml_and_gp</span><span class="p">:</span>
            <span class="n">keep_same_attributes_ml_and_gp</span> <span class="o">=</span> <span class="n">KEEP_SAME_ATTRIBUTES_ML_AND_GP</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">managed_lanes_required_attributes</span><span class="p">:</span>
            <span class="n">managed_lanes_required_attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;managed_lanes_required_attributes&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">managed_lanes_required_attributes</span><span class="p">:</span>
            <span class="n">managed_lanes_required_attributes</span> <span class="o">=</span> <span class="n">MANAGED_LANES_REQUIRED_ATTRIBUTES</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">managed_lanes_node_id_scalar</span><span class="p">:</span>
            <span class="n">managed_lanes_node_id_scalar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;managed_lanes_node_id_scalar&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">managed_lanes_node_id_scalar</span><span class="p">:</span>
            <span class="n">managed_lanes_node_id_scalar</span> <span class="o">=</span> <span class="n">MANAGED_LANES_NODE_ID_SCALAR</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">managed_lanes_link_id_scalar</span><span class="p">:</span>
            <span class="n">managed_lanes_link_id_scalar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;managed_lanes_link_id_scalar&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">managed_lanes_link_id_scalar</span><span class="p">:</span>
            <span class="n">managed_lanes_link_id_scalar</span> <span class="o">=</span> <span class="n">MANAGED_LANES_LINK_ID_SCALAR</span>

        <span class="n">keep_same_attributes_ml_and_gp</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span><span class="n">keep_same_attributes_ml_and_gp</span> <span class="o">+</span> <span class="n">keep_additional_attributes_ml_and_gp</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">link_attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">ml_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">link_attributes</span> <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ML_&quot;</span><span class="p">)]</span>
        <span class="n">non_ml_attributes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">link_attributes</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ML_&quot;</span><span class="p">)]</span>

        <span class="c1"># arrange the attribute list so that ML attributes will be applied at last in the for loop</span>
        <span class="c1"># and does not get overwritten to empty string</span>
        <span class="n">link_attributes_ordered</span> <span class="o">=</span> <span class="n">non_ml_attributes</span> <span class="o">+</span> <span class="n">ml_attributes</span>

        <span class="c1"># non_ml_links are links in the network where there is no managed lane.</span>
        <span class="c1"># gp_links are the gp lanes and ml_links are ml lanes respectively for the ML roadways.</span>

        <span class="n">non_ml_links_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;managed&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">non_ml_links_df</span> <span class="o">=</span> <span class="n">non_ml_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">ml_attributes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">ml_links_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="s2">&quot;managed&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">gp_links_df</span> <span class="o">=</span> <span class="n">ml_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">ml_attributes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">link_attributes_ordered</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attr</span> <span class="o">==</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span>
                <span class="n">ml_links_df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Managed Lane &quot;</span> <span class="o">+</span> <span class="n">gp_links_df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">ml_attributes</span> <span class="ow">and</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ML_ACCESS&quot;</span><span class="p">,</span> <span class="s2">&quot;ML_EGRESS&quot;</span><span class="p">]:</span>
                <span class="n">gp_attr</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">ml_links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">gp_attr</span><span class="p">]</span> <span class="o">=</span> <span class="n">ml_links_df</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keep_same_attributes_ml_and_gp</span>
                <span class="ow">and</span> <span class="n">attr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">managed_lanes_required_attributes</span>
            <span class="p">):</span>
                <span class="n">ml_links_df</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">ml_links_df</span> <span class="o">=</span> <span class="n">ml_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">ml_attributes</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">ml_links_df</span><span class="p">[</span><span class="s2">&quot;managed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">gp_links_df</span><span class="p">[</span><span class="s2">&quot;managed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">ml_links_df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ml_links_df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">managed_lanes_node_id_scalar</span>
        <span class="n">ml_links_df</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ml_links_df</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">managed_lanes_node_id_scalar</span>
        <span class="n">ml_links_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_link_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">ml_links_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_link_key</span><span class="p">]</span> <span class="o">+</span> <span class="n">managed_lanes_link_id_scalar</span>
        <span class="p">)</span>
        <span class="n">ml_links_df</span><span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ml_links_df</span><span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="c1"># lambda x: _update_location_reference(x)</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">offset_location_reference</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">ml_links_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ml_links_df</span><span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">create_line_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">ml_links_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">ml_links_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">create_unique_shape_id</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">access_links_df</span><span class="p">,</span> <span class="n">egress_links_df</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">create_dummy_connector_links</span><span class="p">(</span>
            <span class="n">gp_links_df</span><span class="p">,</span> <span class="n">ml_links_df</span>
        <span class="p">)</span>
        <span class="n">access_links_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">access_links_df</span><span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">create_line_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">egress_links_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">egress_links_df</span><span class="p">[</span><span class="s2">&quot;locationReferences&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">create_line_string</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">access_links_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">access_links_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">create_unique_shape_id</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">egress_links_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">egress_links_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">create_unique_shape_id</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">out_links_df</span> <span class="o">=</span> <span class="n">gp_links_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ml_links_df</span><span class="p">)</span>
        <span class="n">out_links_df</span> <span class="o">=</span> <span class="n">out_links_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">access_links_df</span><span class="p">)</span>
        <span class="n">out_links_df</span> <span class="o">=</span> <span class="n">out_links_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">egress_links_df</span><span class="p">)</span>
        <span class="n">out_links_df</span> <span class="o">=</span> <span class="n">out_links_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">non_ml_links_df</span><span class="p">)</span>

        <span class="c1"># drop the duplicate links, if Any</span>
        <span class="c1"># could happen when a new egress/access link gets created which already exist</span>
        <span class="n">out_links_df</span> <span class="o">=</span> <span class="n">out_links_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>
            <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">],</span>
            <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;last&quot;</span>
        <span class="p">)</span>

        <span class="c1"># only the ml_links_df could potenitally have the new added nodes</span>

        <span class="n">out_links_df</span> <span class="o">=</span> <span class="n">out_links_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;access&#39;</span><span class="p">,</span> <span class="s1">&#39;egress&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># only the ml_links_df has the new nodes added</span>
        <span class="n">added_a_nodes</span> <span class="o">=</span> <span class="n">ml_links_df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span>
        <span class="n">added_b_nodes</span> <span class="o">=</span> <span class="n">ml_links_df</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span>

        <span class="n">out_nodes_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span>

        <span class="c1"># add node if it is not already present</span>
        <span class="k">for</span> <span class="n">a_node</span> <span class="ow">in</span> <span class="n">added_a_nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a_node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out_nodes_df</span><span class="p">[</span><span class="s2">&quot;model_node_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                <span class="n">out_nodes_df</span> <span class="o">=</span> <span class="n">out_nodes_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;model_node_id&quot;</span><span class="p">:</span> <span class="n">a_node</span><span class="p">,</span>
                        <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span>
                            <span class="n">out_links_df</span><span class="p">[</span><span class="n">out_links_df</span><span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">a_node</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span>
                                <span class="s2">&quot;locationReferences&quot;</span>
                            <span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;point&quot;</span><span class="p">]</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;drive_access&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">b_node</span> <span class="ow">in</span> <span class="n">added_b_nodes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b_node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out_nodes_df</span><span class="p">[</span><span class="s2">&quot;model_node_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">():</span>
                <span class="n">out_nodes_df</span> <span class="o">=</span> <span class="n">out_nodes_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;model_node_id&quot;</span><span class="p">:</span> <span class="n">b_node</span><span class="p">,</span>
                        <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span>
                            <span class="n">out_links_df</span><span class="p">[</span><span class="n">out_links_df</span><span class="p">[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">b_node</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span>
                                <span class="s2">&quot;locationReferences&quot;</span>
                            <span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;point&quot;</span><span class="p">]</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;drive_access&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">out_nodes_df</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_nodes_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="n">out_nodes_df</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_nodes_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">g</span><span class="p">:</span> <span class="n">g</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

        <span class="n">out_shapes_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shapes_df</span>

        <span class="c1"># managed lanes, access and egress connectors are new geometry</span>
        <span class="n">new_shapes_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;geometry&quot;</span><span class="p">:</span> <span class="n">ml_links_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span>
                <span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">access_links_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">])</span>
                <span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">egress_links_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">])</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">new_shapes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_shapes_df</span><span class="p">[</span><span class="s2">&quot;geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">create_unique_shape_id</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">out_shapes_df</span> <span class="o">=</span> <span class="n">out_shapes_df</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_shapes_df</span><span class="p">)</span>
        <span class="n">out_shapes_df</span> <span class="o">=</span> <span class="n">out_shapes_df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span>
            <span class="n">subset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shape_foreign_key</span><span class="p">,</span>
            <span class="n">keep</span><span class="o">=</span><span class="s2">&quot;first&quot;</span>
        <span class="p">)</span>

        <span class="n">out_links_df</span> <span class="o">=</span> <span class="n">out_links_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">out_nodes_df</span> <span class="o">=</span> <span class="n">out_nodes_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">out_shapes_df</span> <span class="o">=</span> <span class="n">out_shapes_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">in_place</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span> <span class="o">=</span> <span class="n">out_links_df</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span> <span class="o">=</span> <span class="n">out_nodes_df</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shapes_df</span> <span class="o">=</span> <span class="n">out_shapes_df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out_network</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">out_network</span><span class="o">.</span><span class="n">links_df</span> <span class="o">=</span> <span class="n">out_links_df</span>
            <span class="n">out_network</span><span class="o">.</span><span class="n">nodes_df</span> <span class="o">=</span> <span class="n">out_nodes_df</span>
            <span class="n">out_network</span><span class="o">.</span><span class="n">shapes_df</span> <span class="o">=</span> <span class="n">out_shapes_df</span>
            <span class="k">return</span> <span class="n">out_network</span></div>

<div class="viewcode-block" id="RoadwayNetwork.get_modal_links_nodes"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.get_modal_links_nodes">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_modal_links_nodes</span><span class="p">(</span>
        <span class="n">links_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">nodes_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">modes</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">modes_to_network_link_variables</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">MODES_TO_NETWORK_LINK_VARIABLES</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">DataFrame</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns nodes and link dataframes for specific mode.</span>

<span class="sd">        Args:</span>
<span class="sd">            links_df: DataFrame of standard network links</span>
<span class="sd">            nodes_df: DataFrame of standard network nodes</span>
<span class="sd">            modes: list of the modes of the network to be kept, must be in `drive`,`transit`,`rail`,`bus`,</span>
<span class="sd">                `walk`, `bike`. For example, if bike and walk are selected, both bike and walk links will be kept.</span>
<span class="sd">            modes_to_network_link_variables: dictionary mapping the mode selections to the network variables</span>
<span class="sd">                that must bool to true to select that mode. Defaults to MODES_TO_NETWORK_LINK_VARIABLES</span>

<span class="sd">        Returns: tuple of DataFrames for links, nodes filtered by mode</span>

<span class="sd">        .. todo:: Right now we don&#39;t filter the nodes because transit-only</span>
<span class="sd">        links with walk access are not marked as having walk access</span>
<span class="sd">        Issue discussed in https://github.com/wsp-sag/network_wrangler/issues/145</span>
<span class="sd">        modal_nodes_df = nodes_df[nodes_df[mode_node_variable] == 1]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modes_to_network_link_variables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;mode value should be one of </span><span class="si">{}</span><span class="s2">, got </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="n">modes_to_network_link_variables</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">mode</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">mode_link_variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">mode</span>
                    <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">modes</span>
                    <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">modes_to_network_link_variables</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">mode_node_variables</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">mode</span>
                    <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">modes</span>
                    <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">modes_to_network_link_variables</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">mode_link_variables</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> not in provided links_df list of columns. Available columns are: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">mode_link_variables</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="n">links_df</span><span class="o">.</span><span class="n">columns</span>
            <span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">mode_node_variables</span><span class="p">)</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> not in provided nodes_df list of columns. Available columns are: </span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span><span class="n">mode_node_variables</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="n">nodes_df</span><span class="o">.</span><span class="n">columns</span>
            <span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">modal_links_df</span> <span class="o">=</span> <span class="n">links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">links_df</span><span class="p">[</span><span class="n">mode_link_variables</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>

        <span class="c1">##TODO right now we don&#39;t filter the nodes because transit-only</span>
        <span class="c1"># links with walk access are not marked as having walk access</span>
        <span class="c1"># Issue discussed in https://github.com/wsp-sag/network_wrangler/issues/145</span>
        <span class="c1"># modal_nodes_df = nodes_df[nodes_df[mode_node_variable] == 1]</span>
        <span class="n">modal_nodes_df</span> <span class="o">=</span> <span class="n">nodes_df</span>

        <span class="k">return</span> <span class="n">modal_links_df</span><span class="p">,</span> <span class="n">modal_nodes_df</span></div>

<div class="viewcode-block" id="RoadwayNetwork.get_modal_graph"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.get_modal_graph">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_modal_graph</span><span class="p">(</span>
        <span class="n">links_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">nodes_df</span><span class="p">:</span> <span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">modes_to_network_link_variables</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">MODES_TO_NETWORK_LINK_VARIABLES</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determines if the network graph is &quot;strongly&quot; connected</span>
<span class="sd">        A graph is strongly connected if each vertex is reachable from every other vertex.</span>

<span class="sd">        Args:</span>
<span class="sd">            links_df: DataFrame of standard network links</span>
<span class="sd">            nodes_df: DataFrame of standard network nodes</span>
<span class="sd">            mode: mode of the network, one of `drive`,`transit`,</span>
<span class="sd">                `walk`, `bike`</span>
<span class="sd">            modes_to_network_link_variables: dictionary mapping the mode selections to the network variables</span>
<span class="sd">                that must bool to true to select that mode. Defaults to MODES_TO_NETWORK_LINK_VARIABLES</span>

<span class="sd">        Returns: networkx: osmnx: DiGraph  of network</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">modes_to_network_link_variables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;mode value should be one of </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">modes_to_network_link_variables</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">_links_df</span><span class="p">,</span> <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">get_modal_links_nodes</span><span class="p">(</span>
            <span class="n">links_df</span><span class="p">,</span> <span class="n">nodes_df</span><span class="p">,</span> <span class="n">modes</span><span class="o">=</span><span class="p">[</span><span class="n">mode</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">ox_graph</span><span class="p">(</span><span class="n">_nodes_df</span><span class="p">,</span> <span class="n">_links_df</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">G</span></div>

<div class="viewcode-block" id="RoadwayNetwork.is_network_connected"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.is_network_connected">[docs]</a>    <span class="k">def</span> <span class="nf">is_network_connected</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">links_df</span><span class="p">:</span> <span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">nodes_df</span><span class="p">:</span> <span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if the network graph is &quot;strongly&quot; connected</span>
<span class="sd">        A graph is strongly connected if each vertex is reachable from every other vertex.</span>

<span class="sd">        Args:</span>
<span class="sd">            mode:  mode of the network, one of `drive`,`transit`,</span>
<span class="sd">                `walk`, `bike`</span>
<span class="sd">            links_df: DataFrame of standard network links</span>
<span class="sd">            nodes_df: DataFrame of standard network nodes</span>

<span class="sd">        Returns: boolean</span>

<span class="sd">        .. todo:: Consider caching graphs if they take a long time.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">nodes_df</span> <span class="k">if</span> <span class="n">nodes_df</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span>
        <span class="n">_links_df</span> <span class="o">=</span> <span class="n">links_df</span> <span class="k">if</span> <span class="n">links_df</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span>

        <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">_links_df</span><span class="p">,</span> <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">get_modal_links_nodes</span><span class="p">(</span>
                <span class="n">_links_df</span><span class="p">,</span> <span class="n">_nodes_df</span><span class="p">,</span> <span class="n">modes</span><span class="o">=</span><span class="p">[</span><span class="n">mode</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Assessing connectivity without a mode</span><span class="se">\</span>
<span class="s2">                specified. This may have limited value in interpretation.</span><span class="se">\</span>
<span class="s2">                To add mode specificity, add the keyword `mode =` to calling</span><span class="se">\</span>
<span class="s2">                this method&quot;</span>
            <span class="p">)</span>

        <span class="c1"># TODO: consider caching graphs if they start to take forever</span>
        <span class="c1">#      and we are calling them more than once.</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">ox_graph</span><span class="p">(</span><span class="n">_nodes_df</span><span class="p">,</span> <span class="n">_links_df</span><span class="p">)</span>
        <span class="n">is_connected</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">is_strongly_connected</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">is_connected</span></div>

<div class="viewcode-block" id="RoadwayNetwork.add_incident_link_data_to_nodes"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.add_incident_link_data_to_nodes">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">add_incident_link_data_to_nodes</span><span class="p">(</span>
        <span class="n">links_df</span><span class="p">:</span> <span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nodes_df</span><span class="p">:</span> <span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">link_variables</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="n">unique_node_key</span> <span class="o">=</span> <span class="n">UNIQUE_NODE_KEY</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add data from links going to/from nodes to node.</span>

<span class="sd">        Args:</span>
<span class="sd">            links_df: if specified, will assess connectivity of this</span>
<span class="sd">                links list rather than self.links_df</span>
<span class="sd">            nodes_df: if specified, will assess connectivity of this</span>
<span class="sd">                nodes list rather than self.nodes_df</span>
<span class="sd">            link_variables: list of columns in links dataframe to add to incident nodes</span>

<span class="sd">        Returns:</span>
<span class="sd">            nodes DataFrame with link data where length is N*number of links going in/out</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding following link data to nodes: &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">())</span>

        <span class="n">_link_vals_to_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">link_variables</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">links_df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">link_variables</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_link_vals_to_nodes</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Following columns not in links_df and wont be added to nodes: </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">link_variables</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">_link_vals_to_nodes</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="n">_nodes_from_links_A</span> <span class="o">=</span> <span class="n">nodes_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">links_df</span><span class="p">[[</span><span class="s2">&quot;A&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">_link_vals_to_nodes</span><span class="p">],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
            <span class="n">left_on</span><span class="o">=</span><span class="n">unique_node_key</span><span class="p">,</span>
            <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_nodes_from_links_B</span> <span class="o">=</span> <span class="n">nodes_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">links_df</span><span class="p">[[</span><span class="s2">&quot;B&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">_link_vals_to_nodes</span><span class="p">],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span>
            <span class="n">left_on</span><span class="o">=</span><span class="n">unique_node_key</span><span class="p">,</span>
            <span class="n">right_on</span><span class="o">=</span><span class="s2">&quot;B&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">_nodes_from_links_ab</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">_nodes_from_links_A</span><span class="p">,</span> <span class="n">_nodes_from_links_B</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">_nodes_from_links_ab</span></div>

<div class="viewcode-block" id="RoadwayNetwork.identify_segment_endpoints"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.identify_segment_endpoints">[docs]</a>    <span class="k">def</span> <span class="nf">identify_segment_endpoints</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">links_df</span><span class="p">:</span> <span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nodes_df</span><span class="p">:</span> <span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_connecting_links</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">min_distance</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_link_deviation</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            mode:  list of modes of the network, one of `drive`,`transit`,</span>
<span class="sd">                `walk`, `bike`</span>
<span class="sd">            links_df: if specified, will assess connectivity of this</span>
<span class="sd">                links list rather than self.links_df</span>
<span class="sd">            nodes_df: if specified, will assess connectivity of this</span>
<span class="sd">                nodes list rather than self.nodes_df</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">SEGMENT_IDENTIFIERS</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;ref&quot;</span><span class="p">]</span>

        <span class="n">NAME_PER_NODE</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">REF_PER_NODE</span> <span class="o">=</span> <span class="mi">2</span>

        <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">nodes_df</span> <span class="k">if</span> <span class="n">nodes_df</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span>
        <span class="n">_links_df</span> <span class="o">=</span> <span class="n">links_df</span> <span class="k">if</span> <span class="n">links_df</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span>

        <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">_links_df</span><span class="p">,</span> <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">get_modal_links_nodes</span><span class="p">(</span>
                <span class="n">_links_df</span><span class="p">,</span> <span class="n">_nodes_df</span><span class="p">,</span> <span class="n">modes</span><span class="o">=</span><span class="p">[</span><span class="n">mode</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Assessing connectivity without a mode</span><span class="se">\</span>
<span class="s2">                specified. This may have limited value in interpretation.</span><span class="se">\</span>
<span class="s2">                To add mode specificity, add the keyword `mode =` to calling</span><span class="se">\</span>
<span class="s2">                this method&quot;</span>
            <span class="p">)</span>

        <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">add_incident_link_data_to_nodes</span><span class="p">(</span>
            <span class="n">links_df</span><span class="o">=</span><span class="n">_links_df</span><span class="p">,</span>
            <span class="n">nodes_df</span><span class="o">=</span><span class="n">_nodes_df</span><span class="p">,</span>
            <span class="n">link_variables</span><span class="o">=</span><span class="n">SEGMENT_IDENTIFIERS</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;distance&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Node/Link table elements: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_nodes_df</span><span class="p">)))</span>

        <span class="c1"># Screen out segments that have blank name AND refs</span>
        <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">_nodes_df</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^\s*$&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span>
            <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;ref&quot;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Node/Link table elements after dropping empty name AND ref : </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">_nodes_df</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Screen out segments that aren&#39;t likely to be long enough</span>
        <span class="c1"># Minus 1 in case ref or name is missing on an intermediate link</span>
        <span class="n">_min_ref_in_table</span> <span class="o">=</span> <span class="n">REF_PER_NODE</span> <span class="o">*</span> <span class="p">(</span><span class="n">min_connecting_links</span> <span class="o">-</span> <span class="n">max_link_deviation</span><span class="p">)</span>
        <span class="n">_min_name_in_table</span> <span class="o">=</span> <span class="n">NAME_PER_NODE</span> <span class="o">*</span> <span class="p">(</span><span class="n">min_connecting_links</span> <span class="o">-</span> <span class="n">max_link_deviation</span><span class="p">)</span>

        <span class="n">_nodes_df</span><span class="p">[</span><span class="s2">&quot;ref_freq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_nodes_df</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_nodes_df</span><span class="p">[</span><span class="s2">&quot;ref&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
        <span class="n">_nodes_df</span><span class="p">[</span><span class="s2">&quot;name_freq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_nodes_df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">_nodes_df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>

        <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">_nodes_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">_nodes_df</span><span class="p">[</span><span class="s2">&quot;ref_freq&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">_min_ref_in_table</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">_nodes_df</span><span class="p">[</span><span class="s2">&quot;name_freq&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">_min_name_in_table</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Node/Link table has n = </span><span class="si">{}</span><span class="s2"> after screening segments for min length:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">_nodes_df</span><span class="p">),</span>
                <span class="n">_nodes_df</span><span class="p">[</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span><span class="p">,</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ref&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;distance&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ref_freq&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;name_freq&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># ----------------------------------------</span>
        <span class="c1"># Find nodes that are likely endpoints</span>
        <span class="c1"># ----------------------------------------</span>

        <span class="c1"># - Likely have one incident link and one outgoing link</span>
        <span class="n">_max_ref_endpoints</span> <span class="o">=</span> <span class="n">REF_PER_NODE</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">_max_name_endpoints</span> <span class="o">=</span> <span class="n">NAME_PER_NODE</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="c1"># - Attach frequency  of node/ref</span>
        <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">_nodes_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">_nodes_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span><span class="p">,</span> <span class="s2">&quot;ref&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">size</span><span class="p">()</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;ref_N_freq&quot;</span><span class="p">),</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span><span class="p">,</span> <span class="s2">&quot;ref&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># WranglerLogger.debug(&quot;_ref_count+_nodes:\n{}&quot;.format(_nodes_df[[&quot;model_node_id&quot;,&quot;ref&quot;,&quot;name&quot;,&quot;ref_N_freq&quot;]]))</span>
        <span class="c1"># - Attach frequency  of node/name</span>
        <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">_nodes_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">_nodes_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">size</span><span class="p">()</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;name_N_freq&quot;</span><span class="p">),</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="c1"># WranglerLogger.debug(&quot;_name_count+_nodes:\n{}&quot;.format(_nodes_df[[&quot;model_node_id&quot;,&quot;ref&quot;,&quot;name&quot;,&quot;name_N_freq&quot;]]))</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Possible segment endpoints:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">_nodes_df</span><span class="p">[</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span><span class="p">,</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ref&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;distance&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ref_N_freq&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;name_N_freq&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># - Filter possible endpoint list based on node/name node/ref frequency</span>
        <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">_nodes_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">_nodes_df</span><span class="p">[</span><span class="s2">&quot;ref_N_freq&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">_max_ref_endpoints</span><span class="p">)</span>
            <span class="o">|</span> <span class="p">(</span><span class="n">_nodes_df</span><span class="p">[</span><span class="s2">&quot;name_N_freq&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">_max_name_endpoints</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Likely segment endpoints with req_ref&lt;= </span><span class="si">{}</span><span class="s2"> or freq_name&lt;=</span><span class="si">{}</span><span class="s2"> </span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">_nodes_df</span><span class="p">),</span>
                <span class="n">_max_ref_endpoints</span><span class="p">,</span>
                <span class="n">_max_name_endpoints</span><span class="p">,</span>
                <span class="n">_nodes_df</span><span class="p">[</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span><span class="p">,</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ref&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ref_N_freq&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;name_N_freq&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># ----------------------------------------</span>
        <span class="c1"># Assign a segment id</span>
        <span class="c1"># ----------------------------------------</span>
        <span class="n">_nodes_df</span><span class="p">[</span><span class="s2">&quot;segment_id&quot;</span><span class="p">],</span> <span class="n">_segments</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">factorize</span><span class="p">(</span>
            <span class="n">_nodes_df</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">_nodes_df</span><span class="o">.</span><span class="n">ref</span>
        <span class="p">)</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Segments:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_segments</span><span class="p">),</span> <span class="n">_segments</span><span class="p">))</span>

        <span class="c1"># ----------------------------------------</span>
        <span class="c1"># Drop segments without at least two nodes</span>
        <span class="c1"># ----------------------------------------</span>

        <span class="c1"># https://stackoverflow.com/questions/13446480/python-pandas-remove-entries-based-on-the-number-of-occurrences</span>
        <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">_nodes_df</span><span class="p">[</span>
            <span class="n">_nodes_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;segment_id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span><span class="p">])[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span>
            <span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="nb">len</span><span class="p">)</span>
            <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="p">]</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Segments with at least nodes:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">_nodes_df</span><span class="p">),</span>
                <span class="n">_nodes_df</span><span class="p">[</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;ref&quot;</span><span class="p">,</span> <span class="s2">&quot;segment_id&quot;</span><span class="p">]</span>
                <span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># ----------------------------------------</span>
        <span class="c1"># For segments with more than two nodes, find farthest apart pairs</span>
        <span class="c1"># ----------------------------------------</span>

        <span class="k">def</span> <span class="nf">_max_segment_distance</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
            <span class="n">_segment_nodes</span> <span class="o">=</span> <span class="n">_nodes_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">_nodes_df</span><span class="p">[</span><span class="s2">&quot;segment_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;segment_id&quot;</span><span class="p">]]</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">_segment_nodes</span><span class="o">.</span><span class="n">geometry</span><span class="o">.</span><span class="n">distance</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">dropna</span><span class="p">())</span>

        <span class="n">_nodes_df</span><span class="p">[</span><span class="s2">&quot;seg_distance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_nodes_df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">_max_segment_distance</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">_nodes_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">_nodes_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;segment_id&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">seg_distance</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="nb">max</span><span class="p">)</span>
            <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;max_seg_distance&quot;</span><span class="p">),</span>
            <span class="n">on</span><span class="o">=</span><span class="s2">&quot;segment_id&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">_nodes_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">_nodes_df</span><span class="p">[</span><span class="s2">&quot;max_seg_distance&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">_nodes_df</span><span class="p">[</span><span class="s2">&quot;seg_distance&quot;</span><span class="p">])</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">_nodes_df</span><span class="p">[</span><span class="s2">&quot;seg_distance&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span><span class="p">,</span> <span class="s2">&quot;segment_id&quot;</span><span class="p">])</span>

        <span class="c1"># ----------------------------------------</span>
        <span class="c1"># Reassign segment id for final segments</span>
        <span class="c1"># ----------------------------------------</span>
        <span class="n">_nodes_df</span><span class="p">[</span><span class="s2">&quot;segment_id&quot;</span><span class="p">],</span> <span class="n">_segments</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">factorize</span><span class="p">(</span>
            <span class="n">_nodes_df</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">_nodes_df</span><span class="o">.</span><span class="n">ref</span>
        <span class="p">)</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Segments:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">_segments</span><span class="p">),</span>
                <span class="n">_nodes_df</span><span class="p">[</span>
                    <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span><span class="p">,</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;ref&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;segment_id&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;seg_distance&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">],</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">_nodes_df</span><span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;segment_id&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span><span class="p">,</span> <span class="s2">&quot;geometry&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;ref&quot;</span><span class="p">]</span>
        <span class="p">]</span></div>

<div class="viewcode-block" id="RoadwayNetwork.identify_segment"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.identify_segment">[docs]</a>    <span class="k">def</span> <span class="nf">identify_segment</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">O_id</span><span class="p">,</span>
        <span class="n">D_id</span><span class="p">,</span>
        <span class="n">selection_dict</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nodes_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">links_df</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            endpoints: list of length of two unique keys of nodes making up endpoints of segment</span>
<span class="sd">            selection_dict: dictionary of link variables to select candidate links from, otherwise will create a graph of ALL links which will be both a RAM hog and could result in odd shortest paths.</span>
<span class="sd">            segment_variables: list of variables to keep</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">nodes_df</span> <span class="k">if</span> <span class="n">nodes_df</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span>
        <span class="n">_links_df</span> <span class="o">=</span> <span class="n">links_df</span> <span class="k">if</span> <span class="n">links_df</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span>

        <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">_links_df</span><span class="p">,</span> <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">get_modal_links_nodes</span><span class="p">(</span>
                <span class="n">_links_df</span><span class="p">,</span> <span class="n">_nodes_df</span><span class="p">,</span> <span class="n">modes</span><span class="o">=</span><span class="p">[</span><span class="n">mode</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Assessing connectivity without a mode</span><span class="se">\</span>
<span class="s2">                specified. This may have limited value in interpretation.</span><span class="se">\</span>
<span class="s2">                To add mode specificity, add the keyword `mode =` to calling</span><span class="se">\</span>
<span class="s2">                this method&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">selection_dict</span><span class="p">:</span>
            <span class="n">_query</span> <span class="o">=</span> <span class="s2">&quot; or &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> == </span><span class="si">{</span><span class="nb">repr</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">selection_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="p">)</span>
            <span class="n">_candidate_links</span> <span class="o">=</span> <span class="n">_links_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">_query</span><span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;Found </span><span class="si">{}</span><span class="s2"> candidate links from </span><span class="si">{}</span><span class="s2"> total links using following query:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">_candidate_links</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">_links_df</span><span class="p">),</span> <span class="n">_query</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_candidate_links</span> <span class="o">=</span> <span class="n">_links_df</span>

            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Not pre-selecting links using selection_dict can use up a lot of RAM and also result in odd segment paths.&quot;</span>
            <span class="p">)</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;_candidate links for segment: </span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">_candidate_links</span><span class="p">[[</span><span class="s2">&quot;u&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;ref&quot;</span><span class="p">]]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_sp</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">candidate_links</span><span class="p">,</span> <span class="n">sp_route</span><span class="p">,</span> <span class="n">sp_links</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_search</span><span class="p">(</span>
                <span class="n">_candidate_links</span><span class="p">,</span> <span class="n">O_id</span><span class="p">,</span> <span class="n">D_id</span>
            <span class="p">)</span>
            <span class="n">_sp</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="n">NoPathFound</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Route not found from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> using selection candidates </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">O_id</span><span class="p">,</span> <span class="n">D_id</span><span class="p">,</span> <span class="n">selection_dict</span>
            <span class="p">)</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">sp_links</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">sp_links</span></div>

<div class="viewcode-block" id="RoadwayNetwork.assess_connectivity"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.assess_connectivity">[docs]</a>    <span class="k">def</span> <span class="nf">assess_connectivity</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">ignore_end_nodes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">links_df</span><span class="p">:</span> <span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nodes_df</span><span class="p">:</span> <span class="n">DataFrame</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns a network graph and list of disconnected subgraphs</span>
<span class="sd">        as described by a list of their member nodes.</span>

<span class="sd">        Args:</span>
<span class="sd">            mode:  list of modes of the network, one of `drive`,`transit`,</span>
<span class="sd">                `walk`, `bike`</span>
<span class="sd">            ignore_end_nodes: if True, ignores stray singleton nodes</span>
<span class="sd">            links_df: if specified, will assess connectivity of this</span>
<span class="sd">                links list rather than self.links_df</span>
<span class="sd">            nodes_df: if specified, will assess connectivity of this</span>
<span class="sd">                nodes list rather than self.nodes_df</span>

<span class="sd">        Returns: Tuple of</span>
<span class="sd">            Network Graph (osmnx flavored networkX DiGraph)</span>
<span class="sd">            List of disconnected subgraphs described by the list of their</span>
<span class="sd">                member nodes (as described by their `model_node_id`)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">nodes_df</span> <span class="k">if</span> <span class="n">nodes_df</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span>
        <span class="n">_links_df</span> <span class="o">=</span> <span class="n">links_df</span> <span class="k">if</span> <span class="n">links_df</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span>

        <span class="k">if</span> <span class="n">mode</span><span class="p">:</span>
            <span class="n">_links_df</span><span class="p">,</span> <span class="n">_nodes_df</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">get_modal_links_nodes</span><span class="p">(</span>
                <span class="n">_links_df</span><span class="p">,</span> <span class="n">_nodes_df</span><span class="p">,</span> <span class="n">modes</span><span class="o">=</span><span class="p">[</span><span class="n">mode</span><span class="p">],</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Assessing connectivity without a mode</span><span class="se">\</span>
<span class="s2">                specified. This may have limited value in interpretation.</span><span class="se">\</span>
<span class="s2">                To add mode specificity, add the keyword `mode =` to calling</span><span class="se">\</span>
<span class="s2">                this method&quot;</span>
            <span class="p">)</span>

        <span class="n">G</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">ox_graph</span><span class="p">(</span><span class="n">_nodes_df</span><span class="p">,</span> <span class="n">_links_df</span><span class="p">)</span>
        <span class="c1"># sub_graphs = [s for s in sorted(nx.strongly_connected_component_subgraphs(G), key=len, reverse=True)]</span>
        <span class="n">sub_graphs</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">s</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">subgraph</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">strongly_connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">)),</span>
                <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span>
                <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>

        <span class="n">sub_graph_nodes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">nx</span><span class="o">.</span><span class="n">strongly_connected_components</span><span class="p">(</span><span class="n">G</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="c1"># sorted on decreasing length, dropping the main sub-graph</span>
        <span class="n">disconnected_sub_graph_nodes</span> <span class="o">=</span> <span class="n">sub_graph_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># dropping the sub-graphs with only 1 node</span>
        <span class="k">if</span> <span class="n">ignore_end_nodes</span><span class="p">:</span>
            <span class="n">disconnected_sub_graph_nodes</span> <span class="o">=</span> <span class="p">[</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">disconnected_sub_graph_nodes</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="p">]</span>

        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> for disconnected networks for mode = </span><span class="si">{}</span><span class="s2">:</span><span class="se">\n</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span><span class="p">,</span>
                <span class="n">mode</span><span class="p">,</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">disconnected_sub_graph_nodes</span><span class="p">))),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">G</span><span class="p">,</span> <span class="n">disconnected_sub_graph_nodes</span></div>

<div class="viewcode-block" id="RoadwayNetwork.network_connection_plot"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.network_connection_plot">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">network_connection_plot</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">disconnected_subgraph_nodes</span><span class="p">:</span> <span class="nb">list</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot a graph to check for network connection.</span>

<span class="sd">        Args:</span>
<span class="sd">            G: OSMNX flavored networkX graph.</span>
<span class="sd">            disconnected_subgraph_nodes: List of disconnected subgraphs described by the list of their</span>
<span class="sd">                member nodes (as described by their `model_node_id`).</span>

<span class="sd">        returns: fig, ax : tuple</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">disconnected_subgraph_nodes</span><span class="p">)):</span>
            <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;#</span><span class="si">%06X</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0xFFFFFF</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span>
            <span class="n">G</span><span class="p">,</span>
            <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
            <span class="n">show</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">close</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">edge_color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">edge_alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
            <span class="n">node_color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span>
            <span class="n">node_alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">node_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">disconnected_subgraph_nodes</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="mi">100</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;X&quot;</span><span class="p">],</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">n</span><span class="p">][</span><span class="s2">&quot;Y&quot;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="RoadwayNetwork.selection_map"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.selection_map">[docs]</a>    <span class="k">def</span> <span class="nf">selection_map</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">selected_link_idx</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">A</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">B</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">candidate_link_idx</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">]</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shows which links are selected for roadway property change or parallel</span>
<span class="sd">        managed lanes category of roadway projects.</span>

<span class="sd">        Args:</span>
<span class="sd">            selected_links_idx: list of selected link indices</span>
<span class="sd">            candidate_links_idx: optional list of candidate link indices to also include in map</span>
<span class="sd">            A: optional foreign key of starting node of a route selection</span>
<span class="sd">            B: optional foreign key of ending node of a route selection</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">WranglerLogger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Selected Links: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Candidate Links: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">selected_link_idx</span><span class="p">,</span> <span class="n">candidate_link_idx</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">graph_link_idx</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">selected_link_idx</span> <span class="o">+</span> <span class="n">candidate_link_idx</span><span class="p">))</span>
        <span class="n">graph_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">graph_link_idx</span><span class="p">]</span>

        <span class="n">node_list_foreign_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
            <span class="nb">set</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">i</span>
                    <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_foreign_key</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">graph_links</span><span class="p">[</span><span class="n">fk</span><span class="p">])</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">graph_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">node_list_foreign_keys</span><span class="p">)]</span>

        <span class="n">G</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">ox_graph</span><span class="p">(</span><span class="n">graph_nodes</span><span class="p">,</span> <span class="n">graph_links</span><span class="p">)</span>

        <span class="c1"># base map plot with whole graph</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">plot_graph_folium</span><span class="p">(</span>
            <span class="n">G</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tiles</span><span class="o">=</span><span class="s2">&quot;cartodbpositron&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s2">&quot;300px&quot;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="s2">&quot;250px&quot;</span>
        <span class="p">)</span>

        <span class="c1"># plot selection</span>
        <span class="n">selected_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">selected_link_idx</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">selected_links</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="n">pl</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">folium</span><span class="o">.</span><span class="n">_make_folium_polyline</span><span class="p">(</span>
                <span class="n">edge</span><span class="o">=</span><span class="n">row</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">edge_width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">edge_opacity</span><span class="o">=</span><span class="mf">0.8</span>
            <span class="p">)</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="c1"># if have A and B node add them to base map</span>
        <span class="k">def</span> <span class="nf">_folium_node</span><span class="p">(</span><span class="n">node_row</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="n">node_marker</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Marker</span><span class="p">(</span>
                <span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="n">node_row</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">],</span> <span class="n">node_row</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]],</span>
                <span class="n">icon</span><span class="o">=</span><span class="n">folium</span><span class="o">.</span><span class="n">Icon</span><span class="p">(</span><span class="n">icon</span><span class="o">=</span><span class="n">icon</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">node_marker</span>

        <span class="k">if</span> <span class="n">A</span><span class="p">:</span>

            <span class="c1"># WranglerLogger.debug(&quot;A: {}\n{}&quot;.format(A,self.nodes_df[self.nodes_df[RoadwayNetwork.NODE_FOREIGN_KEY] == A]))</span>
            <span class="n">_folium_node</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">A</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
                <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;play&quot;</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">B</span><span class="p">:</span>
            <span class="n">_folium_node</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node_foreign_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">B</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;star&quot;</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">m</span></div>

<div class="viewcode-block" id="RoadwayNetwork.deletion_map"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.deletion_map">[docs]</a>    <span class="k">def</span> <span class="nf">deletion_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">links</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shows which links and nodes are deleted from the roadway network</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># deleted_links = None</span>
        <span class="c1"># deleted_nodes = None</span>

        <span class="n">missing_error_message</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">links</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">links</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">deleted_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">val</span><span class="p">)]</span>

                <span class="n">node_list_foreign_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">set</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">i</span>
                            <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_foreign_key</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">deleted_links</span><span class="p">[</span><span class="n">fk</span><span class="p">])</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">candidate_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">node_list_foreign_keys</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deleted_links</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">nodes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">deleted_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">val</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">deleted_nodes</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">G</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">ox_graph</span><span class="p">(</span><span class="n">candidate_nodes</span><span class="p">,</span> <span class="n">deleted_links</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">plot_graph_folium</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">tiles</span><span class="o">=</span><span class="s2">&quot;cartodbpositron&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_folium_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="n">node_circle</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span>
                <span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]],</span>
                <span class="n">radius</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">fill_opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">node_circle</span>

        <span class="k">if</span> <span class="n">deleted_nodes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">deleted_nodes</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">_folium_node</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">m</span></div>

<div class="viewcode-block" id="RoadwayNetwork.addition_map"><a class="viewcode-back" href="../../../_generated/network_wrangler.RoadwayNetwork/#network_wrangler.RoadwayNetwork.addition_map">[docs]</a>    <span class="k">def</span> <span class="nf">addition_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">links</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Shows which links and nodes are added to the roadway network</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">links</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">link_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">links</span><span class="p">:</span>
                <span class="n">link_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_link_key</span><span class="p">))</span>

            <span class="n">added_links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">links_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_link_key</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">link_ids</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">node_list_foreign_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                <span class="nb">set</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">i</span>
                        <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_foreign_key</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">added_links</span><span class="p">[</span><span class="n">fk</span><span class="p">])</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">candidate_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">node_list_foreign_keys</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">nodes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">node_ids</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
                <span class="n">node_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span><span class="p">))</span>

            <span class="n">added_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_node_key</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">node_ids</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">added_nodes</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">G</span> <span class="o">=</span> <span class="n">RoadwayNetwork</span><span class="o">.</span><span class="n">ox_graph</span><span class="p">(</span><span class="n">candidate_nodes</span><span class="p">,</span> <span class="n">added_links</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">ox</span><span class="o">.</span><span class="n">plot_graph_folium</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">edge_color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">tiles</span><span class="o">=</span><span class="s2">&quot;cartodbpositron&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_folium_node</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">icon</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="n">node_circle</span> <span class="o">=</span> <span class="n">folium</span><span class="o">.</span><span class="n">Circle</span><span class="p">(</span>
                <span class="n">location</span><span class="o">=</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s2">&quot;Y&quot;</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="s2">&quot;X&quot;</span><span class="p">]],</span>
                <span class="n">radius</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                <span class="n">fill_opacity</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">node_circle</span>

        <span class="k">if</span> <span class="n">added_nodes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">added_nodes</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                <span class="n">_folium_node</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">add_to</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">m</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2022, Metropolitan Council, Metropolitan Transportation Commission.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>